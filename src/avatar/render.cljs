(ns avatar.render
  (:require [avatar.config :as cfg]))

(defn with-keys
  "Given a seq of hiccup nodes, attach stable React keys.
   If a node already has :key in attrs or ^{:key ...} metadata, leave it alone."
  [nodes]
  (->> nodes
       (map-indexed
        (fn [i node]
          (cond
            (nil? node) nil
            (-> node meta :key) node
            (and (vector? node)
                 (map? (nth node 1 nil))
                 (contains? (nth node 1) :key))
            node
            :else
            (with-meta node {:key (str "k" i)}))))
       (remove nil?)))

(defn asset-root
  "Wrap geometry in a group centered on a normalized 100x100 asset space."
  [& children]
  (into
   [:g {:transform "translate(-50 -50)"}]
   (with-keys children)))

(declare resolve-renderer clamp-cfg)

;; -------------------------
;; Head renderers
;; -------------------------

(def head-gradient-x-nudge
  "Adjust the shared forehead highlight horizontally for every head shape."
  25)

(def head-gradient-y-nudge
  "Adjust the shared forehead highlight vertically for every head shape."
  15)

(def head-skin-gradients
  {:light-cream
   {:type :matrix
    :a -13.0281 :b 40.5658 :c -23.7024 :d -6.44796 :tx 30 :ty 26
    :stops [{:offset "0.0664206" :color "white"}
            {:offset "0.293827" :color "#FFFFDA"}
            {:offset "0.594666" :color "#FFF1C8"}
            {:offset "0.776534" :color "#ECCEBB"}
            {:offset "1" :color "white"}]}

   :golden
   {:type :matrix
    :a -13.3582 :b 41.5937 :c -24.3029 :d -6.61134 :tx 31.3419 :ty 22.4688
    :stops [{:offset "0.0664206" :color "#F3F1D5"}
            {:offset "0.25" :color "#F4DF9C"}
            {:offset "0.475962" :color "#F6C985"}
            {:offset "0.706731" :color "#F7C180"}
            {:offset "0.889423" :color "#F6CD9A"}]}

   :tan
   {:type :matrix
    :a -13.3002 :b 41.413 :c -24.1974 :d -6.58262 :tx 31.234 :ty 22.395
    :stops [{:offset "0.0664206" :color "#F7EFB4"}
            {:offset "0.25" :color "#F2D17A"}
            {:offset "0.475962" :color "#EAB359"}
            {:offset "0.706731" :color "#D78948"}
            {:offset "0.889423" :color "#E0A76A"}]}

   :peach
   {:type :matrix
    :a -13.1009 :b 40.7924 :c -23.8348 :d -6.48398 :tx 30.8634 :ty 22.1419
    :stops [{:offset "0.0664206" :color "#F1F1DF"}
            {:offset "0.25" :color "#F2E1B8"}
            {:offset "0.475962" :color "#F3C996"}
            {:offset "0.706731" :color "#F6B08B"}
            {:offset "0.889423" :color "#F5C2A3"}]}

   :deep-brown
   {:type :matrix
    :a -12.9887 :b 41.3582 :c -23.6308 :d -6.57392 :tx 30.8285 :ty 22.3727
    :stops [{:offset "0.0336538" :color "#F7B48B"}
            {:offset "0.336483" :color "#E79047"}
            {:offset "0.536638" :color "#C16F2E"}
            {:offset "0.747635" :color "#904A1F"}
            {:offset "0.920358" :color "#AF6B42"}]}

   :dark-espresso
   {:type :matrix
    :a -13.0281 :b 40.5658 :c -23.7024 :d -6.44796 :tx 30.728 :ty 22.0494
    :stops [{:offset "0.0664206" :color "#B69376"}
            {:offset "0.212144" :color "#AB7A48"}
            {:offset "0.409312" :color "#996023"}
            {:offset "0.736633" :color "#4C290E"}
            {:offset "0.920443" :color "#68462C"}]}})

(defn head-gradient-transform
  [{:keys [type tx ty rotate sx sy a b c d]}]
  (case type
    :translate
    (str "translate(" (+ tx head-gradient-x-nudge) " " (+ ty head-gradient-y-nudge)
         ") rotate(" rotate ") scale(" sx " " sy ")")

    :matrix
    (str "matrix(" a " " b " " c " " d " "
         (+ tx head-gradient-x-nudge) " " (+ ty head-gradient-y-nudge) ")")))

(defn head-fill-node
  [path skin]
  (let [skin-key (or skin :light-cream)
        gradient (get head-skin-gradients skin-key)
        fallback (get cfg/skin-tones skin-key (get cfg/skin-tones :light-cream))]
    (if gradient
      (let [gradient-id (str "head-skin-gradient-" (random-uuid))]
        [:<>
         [:defs
          [:radialGradient
           {:id gradient-id
            :cx 0
            :cy 0
            :r 1.1
            :gradientUnits "userSpaceOnUse"
            :gradientTransform (head-gradient-transform gradient)}
           (for [{:keys [offset color]} (:stops gradient)]
             ^{:key (str offset "-" color)}
             [:stop {:offset offset
                     :stop-color color}])]]
         [:path {:d path
                 :fill (str "url(#" gradient-id ")")}]] )
      [:path {:d path
              :fill fallback}])))

(defn make-head
  [path]
  (fn [{:keys [skin]}]
    (asset-root
     (head-fill-node path skin))))

(def head-001
  (make-head
   "M71.5377 37.9175C68.3809 25.8578 60.0628 19.9034 50.1126 20.0012C40.1624 20.099 31.0448 25.803 28.2832 37.9175C27.4049 41.7702 27.2939 45.9837 27.8073 50.2083C29.609 65.0348 39.1014 80 50.1126 80C61.092 80 70.6219 64.9303 72.2538 50.2083C72.7249 45.9588 72.5379 41.7383 71.5377 37.9175Z"))

(def head-002
  (make-head
   "M72.0163 37.8043C68.7894 25.8208 60.2864 19.904 50.1151 20.0012C39.9438 20.0984 30.6236 25.7663 27.8006 37.8043C26.9028 41.6327 26.7893 45.8195 27.3141 50.0175C24.8045 69.7188 38.8593 79 50.1151 79C61.3385 79 74.6027 69.6149 72.7483 50.0175C73.2298 45.7949 73.0387 41.601 72.0163 37.8043Z"))

(def head-003
  (make-head
   "M71.5377 37.2775C68.3809 25.312 60.0628 19.4041 50.1126 19.5012C40.1624 19.5982 31.0448 25.2576 28.2832 37.2775C27.4049 41.1001 27.2939 45.2807 27.8073 49.4723C30.0144 66.25 34.2117 84.4056 50.1126 82.3385C66.0135 84.4056 69.6084 66.1463 72.2538 49.4723C72.7248 45.256 72.5379 41.0684 71.5377 37.2775Z"))

(def head-004
  (make-head
   "M72.117 37.2839C68.8797 25.3141 60.3492 19.4041 50.1449 19.5012C39.9407 19.5982 30.5903 25.2597 27.7583 37.2839C26.8576 41.1079 26.7437 45.2899 27.2702 49.4831C28.4943 55.9278 14.2976 80.5 50.1449 80.5C85.9923 80.5 71.1778 55.824 72.8514 49.4831C73.3345 45.2652 73.1427 41.0762 72.117 37.2839Z"))

(def head-005
  (make-head
   "M71.673 37.4053C68.5065 25.3538 60.1628 19.4035 50.182 19.5012C40.2013 19.5989 31.0557 25.299 28.2856 37.4053C27.4047 41.2554 27.2933 45.4659 27.8082 49.6877C29.6155 64.5041 24.5743 76.3362 50.182 80.5C74.9764 76.3362 70.551 64.3996 72.1879 49.6877C72.6604 45.4411 72.6762 41.2234 71.673 37.4053Z"))

(def head-006
  (make-head
   "M71.5377 37.8043C68.3809 25.8208 60.0628 19.904 50.1126 20.0012C40.1624 20.0984 31.0448 25.7663 28.2832 37.8043C27.4049 41.6327 27.2939 45.8195 27.8073 50.0175C29.609 64.7504 23.2657 79 50.1126 79C76.9595 79 70.6219 64.6465 72.2538 50.0175C72.7248 45.7949 72.5379 41.601 71.5377 37.8043Z"))

(def head-007
  (make-head
   "M72.495 37.7648C69.1979 25.8078 60.51 19.9042 50.1176 20.0012C39.7252 20.0981 30.2023 25.7535 27.318 37.7648C26.4007 41.5847 26.2847 45.7622 26.8209 49.9508C27.3121 54.8664 26.657 59.4676 28.1282 63.5836C34.4101 77.3015 36.2622 83 50.1176 83C63.973 83 65.3727 77.2648 71.5963 63.5836C73.054 59.4606 72.7963 54.8569 73.2429 49.9508C73.7348 45.7375 73.5395 41.553 72.495 37.7648Z"))

(def head-008
  (make-head
   "M72.0163 37.8131C68.7894 25.8236 60.2864 19.904 50.1151 20.0012C39.9438 20.0984 30.6236 25.7692 27.8006 37.8131C26.9028 41.6434 26.7893 45.8323 27.3141 50.0324C26.8766 62.7013 24.7437 82.7573 50.1151 84C75.4865 82.7573 72.5306 62.5974 72.7483 50.0324C73.2298 45.8076 73.0387 41.6116 72.0163 37.8131Z"))

(defn head-average [{:keys [skin]}]
  (asset-root
   (head-fill-node
    "M73 46C71 70.3594 60.7025 80 50 80C39.2975 80 29 70.3594 27 46C27 31.6406 37.2975 20 50 20C62.7025 20 73 31.6406 73 46Z"
    skin)))

(defn head-blocky [{:keys [skin]}]
  (asset-root
   (head-fill-node
    "M73 46C67 68.3594 80.7025 80 50 80C19.2975 80 33 68.3594 27 46C27 31.6406 37.2975 20 50 20C62.7025 20 73 31.6406 73 46Z"
    skin)))

(defn head-oval [{:keys [skin]}]
  (asset-root
   (head-fill-node
    "M73 46C73 68.3594 64.7025 80 50 80C35.2975 80 27 68.3594 27 46C27 31.6406 37.2975 20 50 20C62.7025 20 73 31.6406 73 46Z"
    skin)))

(defn head-pointy [{:keys [skin]}]
  (asset-root
   (head-fill-node
    "M73 46C73 60.3594 56.7025 80 50 80C43.2975 80 27 60.3594 27 46C27 31.6406 37.2975 20 50 20C62.7025 20 73 31.6406 73 46Z"
    skin)))

(defn head-egg [{:keys [skin]}]
  (asset-root
   (head-fill-node
    "M73 46C73 60.3594 62.7025 80 50 80C37.2975 80 27 60.3594 27 46C27 31.6406 37.2975 20 50 20C62.7025 20 73 31.6406 73 46Z"
    skin)))

(def head-registry
  {:001 {:label "001" :render head-001 :order 1}
   :002 {:label "002" :render head-002 :order 2}
   :003 {:label "003" :render head-003 :order 3}
   :004 {:label "004" :render head-004 :order 4}
   :005 {:label "005" :render head-005 :order 5}
   :006 {:label "006" :render head-006 :order 6}
   :007 {:label "007" :render head-007 :order 7}
   :008 {:label "008" :render head-008 :order 8}
   ;; Legacy preset-compatible shapes. Kept registered so older saved specs still render.
   :average {:label "Average" :render head-average :order 101}
   :blocky  {:label "Blocky"  :render head-blocky  :order 102}
   :oval    {:label "Oval"    :render head-oval    :order 103}
   :pointy  {:label "Pointy"  :render head-pointy  :order 104}
   :egg     {:label "Egg"     :render head-egg     :order 105}})

(def head-default :001)

(def head-order
  "Controls display order in the UI."
  [:001 :002 :003 :004 :005 :006 :007 :008])

;; -------------------------
;; Hair renderers
;; -------------------------

(defn make-hair
  [{:keys [front front2 back]}]
  (fn hair-renderer [{:keys [color]}]
    {:front
     (when front
       (asset-root
        [:path {:d front :fill color}]))

     :front2
     (when front2
       (asset-root
        [:path {:d front2 :fill color}]))

     :back
     (when back
       (asset-root
        [:path {:d back :fill color}]))}))

(def hair-001
  (make-hair
   {:front
    "M30.4943 43.5L29.072 56H27.572C26.1033 53.3759 21.7967 43.5445 26.9943 30C34.4971 13.0542 66.0015 12.6002 73.4946 30C77.8178 44.1497 74.0061 53.502 72.75 56L71.25 56L69.9943 44.5L67.9943 47L66.9943 47.5L63.4943 38.5L59.9943 44.5L58.9946 45L54.4943 36L50.4943 45L45.9943 36L41.4943 45L40.4943 44.5L36.9943 38.5L33.4943 47.5L32.4943 47L30.4943 43.5Z"}))

(def hair-002
  (make-hair
   {:back
    "M30.7485 76.5L29.7485 79.5C10.7485 60 24.2483 33 30.7485 27C40.2485 15 59.2484 17 68.7485 27C82.5259 46.8304 83.2484 63 68.7485 79.5L67.2485 76.5L65.2485 79.5C63.4722 74.9543 62.2797 72.5368 58.2485 69.5H40.2485C36.5226 73.0768 35.2279 75.3017 33.7485 79.5L30.7485 76.5Z"

    :front
    "M57.7485 20.5C53.2485 34.5 41.7486 50.5 21.2486 63C19.7486 55 20.2485 48 23.7486 38C34.2485 17.5 47.2485 17 57.7485 20.5Z"

    :front2
    "M51.7484 19C69.7484 19.5 82.2484 42.5 78.2484 64L51.7484 19Z"}))

(def hair-bald
  (make-hair {}))

(def hair-003
  (make-hair
   {:back
    "M31.5 81.5L28.5 58L25.5 60.5L18.5 54L20.5 35L28.5 21L34 15.5L43.5 18L45 14.5L50.5 17L55 14.5L58 18L65.5 15.5L72.5 21L79.5 35L82 54L78 58L72.5 60L70 81.5L66.5 83.5L62.5 82.5L50.5 60L39 82.5L35 83.5L31.5 81.5Z"
    :front
    "M20.5 77L19.5 68L27.5 30L34.5 15.5L50.5 19L65.5 15.5L73.5 32L80.5 68L79.5 77L75 78.5L70 69.5L68.5 50L65.5 34L59 21.5H41L32 34L31 63.5L29.5 70L25 78.5L20.5 77Z"
    :front2
    "M34 52L30.5 53.5L26 47.5L30.5 32L38.5 14.5L50.5 18.5L62.5 14.5L69.5 33.5L74 49L68.5 53.5L65.5 52L62 36.5L58 25.5L50.5 24L42.5 25.5L38.5 36L34 52Z"}))

(def hair-004
  (make-hair
   {:back
    "M23.5 60C23.6421 48.9809 23.8971 43.0264 26 34.5H73C75.0593 43.8746 75.4093 49.4186 75.5 59.5C81.5001 73 78.5001 81.5 71.5 89L68.5 82.5C57 91.5 42 91 30.5 82.5L27.5 89C20 81.5 18.5001 72.5 23.5 60Z"
    :front
    "M41.5 30C40.5 41 32 55 20 52.5C24.5 43.5 22.5 36.5 26.5 28C26.5 28 31 14 49.5 14C68 14 73 28 73 28C77 37 74.5 43 79.5 52.5C71 54 61 47 57.5 30C53.5694 28.8097 51.6735 28.0013 49.5 26C47.2622 28.0421 45.3642 28.8386 41.5 30Z"}))

(def hair-005
  (make-hair
   {:back
    "M33.6191 22.4999C41.2724 15.272 52.1277 14.5042 61.1191 18.9999C61.1191 19.0132 61.1182 19.0266 61.1181 19.04C73.6989 25.6676 78.9165 41.675 76.6191 54.9999C76.6191 54.9999 78.6188 83.5 49.6188 83.5C20.6188 83.5 23.1191 54.4999 23.1191 54.4999C22.4716 38.9364 24.2675 31.6051 33.6191 22.4999Z"
    :front
    "M23.1188 54.5C38.6188 52.5 61.1188 30 61.1188 19C53.1188 15 42.6188 14 33.6188 22.5C24.2671 31.6052 22.4712 38.9364 23.1188 54.5Z"
    :front2
    "M57.6188 17.5128C72.721 22.8225 79.1188 40.5 76.6188 55C70.1188 51 60.6188 36 57.6188 17.5128Z"}))

(def hair-006
  (make-hair
   {:front
    "M29.5 37.5L28.25 54L20 43L22.5 40L19 30.5L27.5 26.25V25H28.1429L29 19H30V11.5L44.5 14L50.5 8L56 14L70.5 11.5V19H71.5L71.9286 25H73.0556V26.5L81.5 30.5L78 40L80.25 42.75L71.5 54L70.5 37L59.5 29L50.5 28.5L40.5 29L29.5 37.5Z"}))

;; -------------------------
;; Birthmark renderers
;; -------------------------

(def birthmark-origin
  "Intrinsic anchor point of the birthmark asset itself."
  {:x 27
   :y 72})

(defn make-birthmark
  [element]
  (fn birthmark-renderer []
    (let [[tag attrs] element]
      [tag attrs])))

(defn birthmark-none [] nil)

(def birthmark-001
  (make-birthmark
   [:circle {:cx 27
             :cy 72
             :r 2
             :fill "black"}]))

(defn birthmark-node
  [{:keys [shape size x-offset y-offset scale-factor]}]
  (when (and shape (not= shape :none))
    (let [renderer (resolve-renderer :birthmark shape)
          sc (* (or scale-factor 1.0)
                (clamp-cfg :birthmark/size (or size 1.0)))
          xoff (+ (:birthmark/base-x cfg/geometry)
                  (clamp-cfg :birthmark/x-offset (or x-offset 0)))
          yoff (+ (:birthmark/base-y cfg/geometry)
                  (clamp-cfg :birthmark/y-offset (or y-offset 0)))
          {:keys [x y]} birthmark-origin]
      [:g {:transform "translate(-50 -50)"}
       [:g {:transform (str "translate(" (+ x xoff) " " (+ y yoff) ")")}
        [:g {:transform (str "scale(" sc ") translate(" (- x) " " (- y) ")")}
         (renderer)]]])))

;; -------------------------
;; Eye renderers
;; -------------------------

(defn clip-eyeball
  [{:keys [clip-id clip-path]} & children]
  [:<>
   [:defs
    [:clipPath {:id clip-id}
     [:path {:d clip-path}]]]
   [:g {:clip-path (str "url(#" clip-id ")")}
    (into [:<>] (with-keys children))]])

(defn make-eye
  [{:keys [white eyeball outline lids layers]}]
  (fn eye-renderer [{:keys [iris]}]
    (let [clip-id (str "eye-clip-" (random-uuid))
          path (:path white)]
      (asset-root
       (when white
         [:path {:d path :fill "white"}])
       (when eyeball
         (if white
           (clip-eyeball
            {:clip-id clip-id :clip-path path}
            [:circle {:cx (:cx eyeball) :cy (:cy eyeball) :r (:r eyeball)
                      :fill (or iris "#3B5BA5")}]
            [:circle {:cx (:cx eyeball) :cy (:cy eyeball) :r (:pupil-r eyeball)
                      :fill "black"}])
           [:<>
            [:circle {:cx (:cx eyeball) :cy (:cy eyeball) :r (:r eyeball)
                      :fill (or iris "#3B5BA5")}]
            [:circle {:cx (:cx eyeball) :cy (:cy eyeball) :r (:pupil-r eyeball)
                      :fill "black"}]]))
       (when outline
         [:path {:d path
                 :fill "none"
                 :stroke (:stroke outline)
                 :stroke-width (:stroke-width outline)}])
       (for [{:keys [path fill]} layers]
         ^{:key path}
         [:path {:d path :fill (or fill "black")}])
       (for [{:keys [path fill]} lids]
         ^{:key path}
         [:path {:d path :fill (or fill "black")}])))))

(def eye-001
  (make-eye
   {:eyeball {:cx 43.6 :cy 53.6 :r 17.6 :pupil-r 11.2}
    :layers [{:path "M4.27246 50.6373C15.258 35.6327 30.2421 28.9491 44.8389 29.5025C59.358 30.053 73.1435 37.7541 81.8281 50.7808L75.1719 55.2193C67.8565 44.2463 56.3918 37.9472 44.5361 37.4976C32.758 37.051 20.242 42.3676 10.7275 55.3628L4.27246 50.6373Z"
              :fill "black"}]}))

(def eye-002
  (make-eye
   {:eyeball {:cx 41.5 :cy 57.5 :r 22.5 :pupil-r 15}
    :layers [{:path "M41.8291 24.1266C54.4092 23.7851 66.5306 30.7022 74.3799 44.4206L94.9805 38.151L97.0195 44.8483L77.501 50.7878C78.3654 52.8608 79.1472 55.0513 79.834 57.359L76 58.5006L72.166 59.6413C66.2953 39.9158 53.6101 31.8097 42.0459 32.1237C30.3578 32.4411 17.9844 41.3813 12.8496 59.5866L5.15039 57.4147C11.0156 36.62 25.8923 24.5593 41.8291 24.1266Z"
              :fill "black"}]}))

(def eye-003
  (make-eye
   {:eyeball {:cx 38.6 :cy 53.6 :r 17.6 :pupil-r 11.2}
    :layers [{:path "M50 20C66.929 21.1543 75.3109 27.2724 78.4619 37.125L85.6592 34.1377L88.0469 38.6982L79.8232 44.2227C80.0157 46.4449 80.0381 48.7974 79.916 51.2715L91.8135 50.4766L91.7695 55.999L79.1963 58.6426C79.1336 59.0919 79.0693 59.5445 79 60H70.5C67.851 45.39 63.05 38 50 36C25.5 36 22.5 45 12.5 66L5 65C10.5 39 23 21 50 20Z"
              :fill "black"}]}))

(defn eye-004 [{:keys [iris]}]
  (let [clip-id (str "eye004-" (random-uuid))]
    (asset-root
     [:circle {:cx 43 :cy 55 :r 26 :fill "white"}]
     [:defs
      [:clipPath {:id clip-id}
       [:circle {:cx 43 :cy 55 :r 26}]]]
     [:g {:clip-path (str "url(#" clip-id ")")}
      [:circle {:cx 37.6 :cy 46.6 :r 21.6 :fill (or iris "#3C06FF")}]
      [:circle {:cx 37.6 :cy 46.6 :r 13.7455 :fill "black"}]]
     [:path
      {:d "M43 21C61.7777 21 77 36.2223 77 55C77 66.2666 71.5181 76.2508 63.0781 82.4375L58.2773 76.0371C64.7747 71.3105 69 63.6496 69 55C69 40.6406 57.3594 29 43 29C28.6406 29 17 40.6406 17 55H9C9 36.2223 24.2223 21 43 21Z"
       :fill "black"}])))

(defn eye-005 [_]
  (asset-root
   [:path
    {:d "M10.5003 47.5C11.5004 42 25.0004 35.0002 39.0003 36.5C52.8733 37.9864 61.3669 42.466 66.8119 53.4698L85.5003 48L87.0003 53L69.8128 61.1407C70.0494 61.9049 70.279 62.691 70.5003 63.5L64.0003 64.5C55.0003 51.5 44.4389 50.2212 20.0003 55.5C12.3202 56.2201 9.50039 53.0001 10.5003 47.5Z"
     :fill "black"}]))

(defn eye-006 [{:keys [iris]}]
  (let [clip-id (str "eye006-" (random-uuid))
        white-path "M79 58.9997C76 76.9999 21.5 77.9999 13 50.9997C9.7532 41.4998 14.5579 38.7678 20 34.9997C39.1586 32.8073 50.3195 34.5067 71 41.4997C77.6495 45.4972 82 46.9999 79 58.9997Z"]
    (asset-root
     [:path {:d white-path :fill "white"}]
     [:defs
      [:clipPath {:id clip-id}
       [:path {:d white-path}]]]
     [:g {:clip-path (str "url(#" clip-id ")")}
      [:circle {:cx 41.6 :cy 49.6 :r 19.4 :fill (or iris "#3C06FF")}]
      [:circle {:cx 41.6 :cy 49.6 :r 12.3455 :fill "black"}]]
     [:path
      {:d "M44.9592 33.0022C57.6309 33.0236 68.0118 33.9482 75.0519 38.2342C78.8 40.5161 81.5546 43.7062 83.2216 47.9385C84.8488 52.0696 85.3643 56.9969 85.0509 62.7223L77.0635 62.2852C77.3414 57.2089 76.8331 53.5462 75.7791 50.8702C74.765 48.2955 73.1807 46.4602 70.8918 45.0668C65.9425 42.0539 57.6196 40.9999 44.5003 40.9999C44.1934 40.9999 43.8871 40.9646 43.5884 40.8947C37.7965 39.5391 33.1439 38.7381 29.3916 38.5507C25.6268 38.3627 23.0892 38.8125 21.3211 39.6669C18.19 41.1802 15.8476 44.8572 15.0447 54.8248L7.07005 54.1817C7.90474 43.8199 10.5341 35.9953 17.84 32.4644C21.2904 30.7968 25.3378 30.3386 29.7906 30.561C34.1427 30.7783 39.1901 31.6664 44.9592 33.0022Z"
       :fill "black"}])))

(defn eye-007 [{:keys [iris mirrored?]}]
  (asset-root
   [:circle {:cx 43.6 :cy 55.6 :r 30.4 :fill (or iris "#3C06FF")}]
   [:circle {:cx 43.6 :cy 55.6 :r 19.3455 :fill "black"}]
   [:g {:transform
        (when mirrored?
          "translate(43.6 0) scale(-1 1) translate(-43.6 0)")}
    [:path {:d "M52.5 34L56.4775 42.5225L65 46.5L56.4775 50.4775L52.5 59L48.5225 50.4775L40 46.5L48.5225 42.5225L52.5 34Z"
            :fill "white"}]
    [:path {:d "M33.5 56L36.8411 63.1589L44 66.5L36.8411 69.8411L33.5 77L30.1589 69.8411L23 66.5L30.1589 63.1589L33.5 56Z"
            :fill "white"}]]
   [:path {:d "M82 21L72.5059 31.7324C73.3641 32.7785 74.1655 33.8726 74.9082 35.0088L89.4004 29.8457L91.1562 34.8623L78.2305 41.3398C78.9241 43.0395 79.4968 44.8008 79.9375 46.6143L93.999 46.6104L93.9727 51.9248L80.9482 53.5293C80.982 54.1819 81 54.8389 81 55.5C81 55.6669 80.9953 55.8336 80.9932 56H73.9951C73.9968 55.8668 74 55.7332 74 55.5996C73.9998 38.8103 60.389 25.2002 43.5996 25.2002C26.8105 25.2004 13.2004 38.8104 13.2002 55.5996C13.2002 55.7332 13.2034 55.8668 13.2051 56H6.00684C6.00466 55.8336 6 55.6669 6 55.5C6 34.7893 22.7893 18 43.5 18C52.6414 18 61.0175 21.2727 67.5244 26.708L78.5 17L82 21Z"
           :fill "black"}]))

(defn eye-008 [_]
  (asset-root
   [:path {:d "M62.4997 58.4996L64.4997 52.9996C48.4997 48.5 23.9998 47.5 15.4997 50.4996C6.99997 54 12.4996 59.9996 14.9997 59.9996C26.5 60 40 55 62.4997 58.4996Z"
           :fill "black"}]
   [:path {:d "M93.0693 51.001L92.9307 55.999L74.9307 55.499L75.0693 50.501L93.0693 51.001Z"
           :fill "black"}]
   [:path {:d "M87.002 72.71L84.998 77.29L68.998 70.29L71.002 65.71L87.002 72.71Z"
           :fill "black"}]))

(defn eye-009 [_]
  (asset-root
   [:path {:d "M63.5977 29.0049L31.835 48H67V55H32.2725L62.7402 72.4639L59.2588 78.5361L18 55V48L60.0039 22.9971L63.5977 29.0049Z"
           :fill "black"}]))

(defn eye-010 [{:keys [iris]}]
  (let [clip-id (str "eye010-" (random-uuid))
        white-path "M34.998 40.958C45.6789 37.0991 58.413 37.7819 73.1064 42.6796L76.75 43.8945L75.2031 47.4091C69.3171 60.7865 60.1631 68.4349 48.9561 71.6171C37.9468 74.7432 25.3469 73.4513 12.5566 69.8701L8.50977 68.7373L10.3555 64.9628C16.1454 53.1197 24.2475 44.8421 34.998 40.958Z"]
    (asset-root
     [:path {:d white-path :fill "white"}]
     [:defs
      [:clipPath {:id clip-id}
       [:path {:d white-path}]]]
     [:g {:clip-path (str "url(#" clip-id ")")}
      [:circle {:cx 38 :cy 50 :r 18 :fill (or iris "#3C06FF")}]
      [:circle {:cx 38 :cy 50 :r 11.6471 :fill "black"}]]
     [:path {:d "M99 30L82 41.5C70.5 81 34 85 2 70C13 35.5 50 17 79 35.5L96.5 26L99 30ZM72 46C43.5 36.5 24.5 43.9999 13.5 66.5C38.5 73.5 61 71 72 46Z"
             :fill "black"
             :fill-rule "evenodd"
             :clip-rule "evenodd"}])))

(defn eye-011 [{:keys [iris]}]
  (asset-root
   [:circle {:cx 38 :cy 50 :r 18 :fill (or iris "#3C06FF")}]
   [:circle {:cx 38 :cy 50 :r 11.6471 :fill "black"}]))

(defn eye-012 [{:keys [iris]}]
  (let [clip-id (str "eye012-" (random-uuid))]
    (asset-root
     [:circle {:cx 50.5 :cy 51.5 :r 30 :fill "white"}]
     [:defs
      [:clipPath {:id clip-id}
       [:circle {:cx 50.5 :cy 51.5 :r 30}]]]
     [:g {:clip-path (str "url(#" clip-id ")")}
      [:circle {:cx 50.5 :cy 51.5 :r 17 :fill (or iris "#3C06FF")}]
      [:circle {:cx 50.5 :cy 51.5 :r 11 :fill "black"}]]
     [:path {:d "M75.5 51.2518C75.5 36.8243 64.6355 24.375 50 24.375C35.3645 24.375 24.5 36.8243 24.5 51.2518C24.5 65.6792 35.9167 77.375 50 77.375C64.0833 77.375 75.5 65.6792 75.5 51.2518ZM83.5 51C83.5 69.5015 68.5015 84.5 50 84.5C31.4985 84.5 16.5 69.5015 16.5 51C16.5 32.4985 31.4985 17.5 50 17.5C68.5015 17.5 83.5 32.4985 83.5 51Z"
             :fill "black"}])))

(defn eye-013 [{:keys [iris]}]
  (let [clip-id (str "eye013-" (random-uuid))
        white-path "M16 41H84C84 86.3333 16 86.3333 16 41Z"]
    (asset-root
     [:path {:d white-path :fill "white"}]
     [:defs
      [:clipPath {:id clip-id}
       [:path {:d white-path}]]]
     [:g {:clip-path (str "url(#" clip-id ")")}
      [:circle {:cx 49.75 :cy 39.4775 :r 23.5 :fill (or iris "#3C06FF")}]
      [:ellipse {:cx 50.25 :cy 39.4775 :rx 15 :ry 15.5 :fill "black"}]]
     [:path {:d "M87.5 37.5V41C87.5 53.2831 82.859 62.7529 75.7002 69.1162C68.6059 75.4222 59.2457 78.5 50 78.5C40.7543 78.5 31.3941 75.4222 24.2998 69.1162C17.141 62.7529 12.5 53.2831 12.5 41V37.5H87.5ZM19.6543 44.5C20.4207 53.0966 25.0079 59.4906 29.9502 63.8838C35.6058 68.911 42.2457 71 50 71C57.7542 71 64.3942 68.911 70.0498 63.8838C74.9921 59.4906 79.5793 53.0966 80.3457 44.5H19.6543Z"
             :fill "black"}])))

(defn eye-014 [{:keys [iris]}]
  (let [clip-id (str "eye014-" (random-uuid))
        white-path "M42.7412 35.6751C57.2775 30.4836 71.8013 35.4767 84.2666 43.3265C79.0439 55.5211 71.0228 66.0412 57.6689 69.7054C43.7774 73.5171 29.5529 69.3509 16.6211 64.18C21.5408 51.604 29.5201 40.3969 42.7412 35.6751Z"]
    (asset-root
     [:path {:d white-path :fill "white"}]
     [:defs
      [:clipPath {:id clip-id}
       [:path {:d white-path}]]]
     [:g {:clip-path (str "url(#" clip-id ")")}
      [:circle {:cx 44 :cy 53.5 :r 19.5 :fill (or iris "#3C06FF")}]
      [:circle {:cx 44 :cy 53.5 :r 12.5 :fill "black"}]]
     [:path {:d "M41.4502 31.3279C58.776 25.1525 77 30.4999 89.7139 42.3201C85 58.9998 74.0481 70.609 57.6406 74.7644C41.5048 78.851 23 73.4998 11.2744 65.7097C15.5 49.4999 25.7694 36.9171 41.4502 31.3279ZM80.5 44.4998C53.5001 27.4999 29.5001 39.4999 20.5 62.4998C48 73.4998 70 68.9998 80.5 44.4998Z"
             :fill "black"
             :fill-rule "evenodd"
             :clip-rule "evenodd"}])))

(defn eye-015 [_]
  (asset-root
   [:path {:d "M18 41H76V50H18V41Z"
           :fill "black"}]))

;; -------------------------
;; Brow renderers
;; -------------------------

(defn make-brow
  "Create a brow renderer from one normalized SVG element."
  [element]
  (fn brow-renderer [{:keys [color]}]
    (asset-root
     (let [[tag attrs] element]
       [tag (assoc attrs :fill (or color "black"))]))))

(defn brow-none [_] nil)

(def brow-001
  (make-brow
   [:path {:d "M62 27.5L6.5 56.5V66.5L80.5 45L62 27.5Z"}]))

(def brow-002
  (make-brow
   [:path {:d "M8.50037 56.5C42.0398 28.635 57.5429 28.4721 81.5004 45.5C82.5 48.5 80.5 50 78.0004 49C59.83 38.4599 47.5507 36.6841 12.5004 59.5C9.50032 60.5 8.00003 59.5 8.50037 56.5Z"}]))

(def brow-003
  (make-brow
   [:path {:d "M55.5 32.5L5.5 48L9 66C57 52 58 51.5 82 57.5L55.5 32.5Z"}]))

(def brow-004
  (make-brow
   [:path {:d "M11.0914 54.0113C43.5529 29.3355 58.5578 29.1912 81.7453 44.2703C82.7128 46.9269 80.777 48.2552 78.3578 47.3697C57.0956 37.2186 48.7578 42.1117 21.5 62.5C13.6126 69.0701 5.13936 62.903 11.0914 54.0113Z"}]))

(def brow-005
  (make-brow
   [:path {:d "M79 43C49 41.6036 39.9558 45.8628 29 64.0001C22 71.5 9.5 68 9.5 55.0001C27 27 55.5 24.9999 79 43Z"}]))

(def brow-006
  (make-brow
   [:rect {:x 11 :y 44 :width 63 :height 17}]))

(def brow-007
  (make-brow
   [:path {:d "M8 43.4999C34.6082 43.1703 46.492 43.3306 55.5 44.9999C64.8392 48.4078 69.6547 51.8843 78 58.9999L73.5 66.9999C65.5721 62.596 61.275 60.3375 55.5 58.9999C37.5 57.4999 26.7077 61.4164 8 59.9999V43.4999Z"}]))

(def brow-008
  (make-brow
   [:path {:d "M44 44.4999C57.5 35 73.5 39.5 83 51.4999C68.388 46.1004 60.2547 43.7399 47 53.4999C26 65.5 11 63 9 57.9999C10.5 47.5 23 57.9999 44 44.4999Z"}]))

;; -------------------------
;; Nose renderers
;; -------------------------

(defn make-nose
  [{:keys [path]}]
  (fn nose-renderer [{:keys [fill]}]
    (asset-root
     [:path {:d path
             :fill (or fill "black")}])))

(defn nose-none [_]
  nil)

(def nose-one
  (make-nose
   {:path "M39.5 62C39.5 55.7383 42.3834 50.912 44.8145 46.5361C47.3008 42.0607 49.5 37.8037 49.5 32C49.5 30.6193 50.6193 29.5 52 29.5C53.3807 29.5 54.5 30.6193 54.5 32C54.5 39.1961 51.6991 44.4394 49.1855 48.9639C46.6166 53.5879 44.5 57.2618 44.5 62C44.5 64.1684 45.1715 65.6553 46.0938 66.7422C47.0553 67.8754 48.4064 68.7055 49.9141 69.2979C51.4149 69.8875 52.9512 70.1943 54.1367 70.3496C54.7228 70.4264 55.2076 70.4639 55.5381 70.4824C55.703 70.4917 55.8288 70.496 55.9082 70.498C55.9476 70.4991 55.9756 70.4998 55.9912 70.5H56.001C57.3812 70.5005 58.5 71.6196 58.5 73C58.5 74.3807 57.3807 75.5 56 75.5V73C56 75.4388 55.9991 75.4985 55.998 75.5H55.9746C55.9626 75.4999 55.9464 75.4993 55.9277 75.499C55.8904 75.4985 55.84 75.4977 55.7773 75.4961C55.6517 75.4928 55.4765 75.4868 55.2588 75.4746C54.8238 75.4502 54.2143 75.4017 53.4883 75.3066C52.0489 75.1182 50.0849 74.7374 48.0859 73.9521C46.0937 73.1695 43.9446 71.937 42.2812 69.9766C40.5786 67.9698 39.5 65.3316 39.5 62Z"}))

(def nose-two
  (make-nose
   {:path "M24.4111 50.0703C25.4769 49.1927 27.052 49.3454 27.9297 50.4111C34.5755 58.481 42.1683 62.25 49.625 62.25C57.0993 62.25 64.963 58.4626 72.125 50.3457C73.0385 49.3104 74.619 49.2115 75.6543 50.125C76.6896 51.0385 76.7884 52.619 75.875 53.6543C68.037 62.5373 58.9007 67.25 49.625 67.25C40.3317 67.25 31.4244 62.5189 24.0703 53.5889C23.1927 52.5231 23.3454 50.948 24.4111 50.0703Z"}))

(def nose-three
  (make-nose
   {:path "M72.794 55.8232C73.4438 54.6051 74.9586 54.1442 76.1768 54.7939C77.395 55.4437 77.8558 56.9585 77.2061 58.1767C73.1282 65.8227 68.8391 71.7221 64.3555 75.7373C59.8562 79.7666 55.0374 82 50 82C44.9627 82 40.1439 79.7666 35.6446 75.7373C31.161 71.7221 26.8719 65.8227 22.794 58.1767C22.1443 56.9585 22.6051 55.4437 23.8233 54.7939C25.0415 54.1442 26.5563 54.6051 27.2061 55.8232C31.1282 63.1771 35.0892 68.5279 38.9805 72.0127C42.8561 75.4833 46.5375 77 50 77C53.4626 77 57.144 75.4833 61.0196 72.0127C64.9109 68.5279 68.8719 63.1771 72.794 55.8232Z"}))

(def nose-four
  (make-nose
   {:path "M39.9254 19.501C41.3053 19.4597 42.4571 20.5449 42.4986 21.9248C43.126 42.7914 41.7365 52.1441 35.4713 61.7881C35.382 65.1973 36.0485 67.1063 37.5934 68.5928C39.3981 70.3292 42.735 71.836 48.9449 73.4072C53.1741 72.1368 56.2785 70.8924 58.4703 69.6103C60.768 68.2663 61.8437 67.0109 62.3033 65.8642C62.752 64.7448 62.7825 63.3068 62.0826 61.2178C61.3721 59.097 59.9854 56.5398 57.9088 53.3701C57.1522 52.2152 57.4756 50.6658 58.6305 49.9092C59.7854 49.1526 61.3348 49.475 62.0914 50.6299C64.2375 53.9056 65.9065 56.8918 66.8238 59.6299C67.7516 62.3993 67.982 65.1363 66.944 67.7256C65.9167 70.2876 63.8181 72.2753 60.9947 73.9267C58.1759 75.5755 54.4167 77.0178 49.7037 78.3994C49.2805 78.5235 48.8313 78.533 48.4029 78.4277C41.7514 76.7924 37.0451 75.0034 34.1266 72.1953C30.9833 69.1708 30.2746 65.361 30.5035 60.873L30.5172 60.7041C30.5638 60.3131 30.7026 59.9379 30.9225 59.6094C36.6087 51.1173 38.1359 43.1736 37.5016 22.0752C37.4601 20.6951 38.5453 19.5424 39.9254 19.501Z"}))

(def nose-five
  (make-nose
   {:path "M67.0626 36.6416C67.8129 35.4827 69.3607 35.1513 70.5197 35.9013C75.2144 38.9407 78.221 42.004 79.7941 45.1064C81.4144 48.3021 81.4272 51.377 80.4396 54.0928C79.4863 56.7139 77.6585 58.8588 75.8068 60.4941C73.9389 62.1437 71.902 63.4024 70.3039 64.2236C68.381 65.2116 65.1417 65.8006 61.6915 66.1728C58.1055 66.5597 53.8627 66.75 49.6417 66.75C45.4204 66.75 41.168 66.5595 37.5626 66.1728C34.0855 65.7999 30.8324 65.2114 28.882 64.2363C25.6171 62.6039 20.6554 58.8823 18.839 53.7148C17.8895 51.0134 17.8218 47.9552 19.2638 44.8008C20.675 41.7138 23.4364 38.741 27.7511 35.9101C28.9055 35.1528 30.4547 35.4745 31.2121 36.6289C31.9694 37.7833 31.6476 39.3324 30.4933 40.0898C26.6568 42.6069 24.7017 44.9329 23.8117 46.8799C22.9525 48.7593 22.9982 50.4701 23.5558 52.0566C24.754 55.4652 28.3832 58.3961 31.1183 59.7637C32.1681 60.2884 34.5803 60.8251 38.0958 61.2021C41.4835 61.5654 45.5526 61.75 49.6417 61.75C53.731 61.75 57.7891 61.5653 61.1554 61.2021C64.6573 60.8243 67.0223 60.2883 68.0187 59.7763C69.3398 59.0975 71.0096 58.0607 72.4972 56.747C74.0009 55.4191 75.1779 53.933 75.7414 52.3838C76.2704 50.929 76.3118 49.2934 75.3351 47.3672C74.311 45.3475 72.0942 42.8768 67.8029 40.0986C66.6439 39.3483 66.3125 37.8006 67.0626 36.6416Z"}))

(def nose-six
  (make-nose
   {:path "M50.2822 37.875C61.0712 38.0134 71.5605 44.6848 75.3915 57.2725C75.7934 58.5933 75.0483 59.9896 73.7275 60.3916C72.4067 60.7934 71.0103 60.0483 70.6083 58.7275C67.4393 48.3155 58.9285 42.9867 50.2177 42.875C41.5186 42.7636 32.4697 47.8676 28.3408 58.8779C27.8559 60.1707 26.4148 60.8256 25.122 60.3408C23.8293 59.856 23.1743 58.4148 23.6591 57.1221C28.5302 44.1326 39.4814 37.7365 50.2822 37.875Z"}))

(def nose-seven
  (make-nose
   {:path "M58.214 20.627C59.5246 20.1931 60.9391 20.9034 61.3732 22.2139C65.1703 33.6831 67.9565 42.8532 68.3536 51.043C68.7602 59.4298 66.6682 66.7263 61.0196 74.4727C60.6944 74.9186 60.2311 75.2446 59.7013 75.3994C56.2851 76.3978 53.4398 76.985 50.5148 77.0029C47.5778 77.0209 44.7183 76.4645 41.2569 75.3867C40.7664 75.234 40.3345 74.9341 40.0206 74.5274C33.2962 65.8123 31.3627 57.9861 32.1476 49.5361C32.9051 41.3811 36.2305 32.6087 39.6232 22.2236C40.0519 20.9112 41.464 20.1953 42.7765 20.624C44.0887 21.0529 44.8048 22.464 44.3761 23.7764C40.8471 34.5787 37.8162 42.5689 37.1261 49.9981C36.4815 56.9374 37.9105 63.3522 43.4991 70.8389C46.2978 71.6639 48.4234 72.0156 50.4845 72.0029C52.543 71.9903 54.6676 71.614 57.4757 70.832C62.0977 64.2439 63.6967 58.2404 63.3595 51.2852C63.0009 43.8895 60.4603 35.3643 56.6271 23.7861C56.1931 22.4755 56.9034 21.061 58.214 20.627Z"}))

(def nose-eight
  (make-nose {:path "M35.3307 67.8838C35.331 67.884 35.3323 67.8839 35.3336 67.8848C35.3364 67.8865 35.3412 67.8901 35.3483 67.8945C35.3625 67.9034 35.3856 67.9174 35.4166 67.9365C35.479 67.9749 35.5744 68.0332 35.6998 68.1084C35.9511 68.2591 36.3224 68.478 36.7907 68.7422C37.7292 69.2718 39.0466 69.9786 40.5592 70.6875C43.6802 72.1502 47.2731 73.4458 50.0485 73.5C52.9742 73.557 56.7896 72.268 60.1139 70.7715C61.7244 70.0465 63.1291 69.3156 64.1305 68.7656C64.6302 68.4912 65.027 68.2637 65.2955 68.1064C65.4297 68.0279 65.5316 67.9669 65.5983 67.9268C65.6316 67.9067 65.6563 67.8921 65.6715 67.8828C65.679 67.8783 65.6842 67.8749 65.6871 67.873C65.6881 67.8725 65.6886 67.8714 65.6891 67.8711L65.7116 67.8574C65.7141 67.8559 65.7199 67.8531 65.7272 67.8486C65.7418 67.8397 65.7659 67.8249 65.7985 67.8047C65.8638 67.7641 65.963 67.7009 66.0914 67.6182C66.349 67.4522 66.7207 67.2072 67.1608 66.8975C68.0488 66.2725 69.1815 65.4109 70.2233 64.4355C71.2915 63.4354 72.1259 62.4415 72.567 61.5703C72.9946 60.7258 72.8917 60.36 72.7907 60.1689C72.2038 59.0595 71.7254 58.4703 71.2438 58.1201C70.8106 57.8052 70.1633 57.5314 68.9342 57.499C67.5366 57.4623 65.5948 57.8687 63.8346 58.3691C62.99 58.6093 62.2478 58.8527 61.7184 59.0361C61.4546 59.1275 61.2458 59.204 61.1051 59.2559C61.035 59.2817 60.9819 59.3016 60.9479 59.3145C60.9309 59.3209 60.9181 59.3253 60.9108 59.3281C60.9073 59.3294 60.9051 59.3306 60.9039 59.3311L60.7594 59.3818C60.0279 59.6151 59.2258 59.4995 58.5875 59.0625C57.9071 58.5964 57.5006 57.8248 57.5006 57V23C57.5006 21.6193 58.6199 20.5 60.0006 20.5C61.3812 20.5002 62.5006 21.6194 62.5006 23V53.5498C64.3379 53.029 66.878 52.4434 69.066 52.501C71.056 52.5534 72.7506 53.0348 74.1832 54.0762C75.5675 55.0825 76.4797 56.4513 77.2096 57.8311C78.3504 59.9877 77.8673 62.1713 77.028 63.8291C76.202 65.4603 74.8821 66.9233 73.6403 68.0859C72.3716 69.2737 71.0387 70.2825 70.0387 70.9863C69.5348 71.341 69.1055 71.6241 68.7994 71.8213C68.6463 71.9199 68.5232 71.9977 68.4362 72.0518C68.3928 72.0787 68.3584 72.1001 68.3336 72.1152C68.3212 72.1228 68.3109 72.1292 68.3034 72.1338C68.3025 72.1343 68.3012 72.1343 68.3004 72.1348L68.2985 72.1367C68.2919 72.1408 68.2832 72.1466 68.2721 72.1533C68.2493 72.1672 68.2166 72.1862 68.1754 72.2109C68.0928 72.2606 67.9738 72.3319 67.8219 72.4209C67.5182 72.5988 67.0809 72.8496 66.5368 73.1484C65.4506 73.7449 63.9249 74.5391 62.1657 75.3311C58.7498 76.8688 54.0648 78.58 49.9518 78.5C46.0552 78.4241 41.648 76.7196 38.4371 75.2148C36.7841 74.4401 35.3526 73.6717 34.3336 73.0967C33.8232 72.8086 33.4134 72.5673 33.1285 72.3965C32.986 72.311 32.8741 72.243 32.7965 72.1953C32.7799 72.1851 32.7651 72.1753 32.7516 72.167C32.7303 72.1555 32.705 72.1425 32.6764 72.127C32.5809 72.075 32.445 71.9997 32.276 71.9043C31.9385 71.7137 31.4651 71.4386 30.9078 71.0938C29.8017 70.4091 28.3256 69.4254 26.9166 68.2568C25.5396 67.1147 24.0645 65.665 23.1246 64.0205C22.1626 62.3373 21.5799 60.0755 22.7994 57.8135C23.5337 56.4517 24.4439 55.0879 25.82 54.083C27.2488 53.0397 28.9392 52.5535 30.9342 52.501C33.1225 52.4434 35.6633 53.029 37.5006 53.5498V23C37.5006 21.6193 38.6199 20.5 40.0006 20.5C41.3812 20.5002 42.5006 21.6194 42.5006 23V57C42.5006 57.8248 42.0933 58.5964 41.4127 59.0625C40.7747 59.4994 39.9732 59.6148 39.2418 59.3818L39.0963 59.3311C39.0951 59.3306 39.0928 59.3294 39.0895 59.3281C39.0822 59.3253 39.0701 59.3208 39.0534 59.3145C39.0193 59.3016 38.9655 59.2818 38.8952 59.2559C38.7545 59.2039 38.5456 59.1275 38.2819 59.0361C37.7526 58.8528 37.011 58.6092 36.1666 58.3691C34.4063 57.8686 32.4637 57.4623 31.066 57.499C29.842 57.5312 29.2004 57.8055 28.7682 58.1211C28.2832 58.4753 27.803 59.0696 27.2008 60.1865C27.1034 60.3673 26.9871 60.702 27.4655 61.5391C27.9661 62.4151 28.9059 63.4111 30.108 64.4082C31.2782 65.3787 32.5469 66.2283 33.5397 66.8428C34.0316 67.1472 34.4466 67.3879 34.735 67.5508C34.8787 67.6319 34.9905 67.6934 35.0641 67.7334C35.1009 67.7534 35.1284 67.7684 35.1452 67.7773C35.1535 67.7818 35.1597 67.7845 35.1627 67.7861L35.1637 67.7871L35.3317 67.8838H35.3307Z"}))

(def nose-nine
  (make-nose {:path "M75.5008 41.0732C75.4604 39.6943 76.5454 38.5428 77.9246 38.501C79.3044 38.4593 80.4568 39.5441 80.4988 40.9238L77.9998 41C80.4987 40.9242 80.4988 40.9252 80.4988 40.9258V40.9297C80.4989 40.932 80.4997 40.9352 80.4998 40.9385C80.5 40.9451 80.4996 40.9536 80.4998 40.9639C80.5003 40.9847 80.5012 41.0133 80.5018 41.0488C80.5029 41.1199 80.5036 41.2197 80.5037 41.3447C80.504 41.5947 80.5004 41.9478 80.4852 42.3779C80.4549 43.2342 80.3782 44.4173 80.1893 45.7148C80.0016 47.0039 79.6946 48.4672 79.1815 49.8584C78.6757 51.2295 77.9113 52.6918 76.7147 53.8193C75.4338 55.026 73.8114 55.7054 72.3055 56.1035C70.7791 56.507 69.1883 56.6693 67.7938 56.7197C66.4303 56.769 65.1888 56.7119 64.2752 56.6426C64.2303 56.7077 64.1866 56.7764 64.1385 56.8447C63.485 57.7734 62.5186 59.0164 61.2674 60.2676C58.8158 62.7191 54.9635 65.5 49.9998 65.5C45.0798 65.4999 40.9966 62.7602 38.3279 60.3584C36.9593 59.1266 35.8713 57.9015 35.1248 56.9854C35.0145 56.85 34.9131 56.7194 34.8172 56.5977C33.979 56.6409 32.8331 56.6666 31.5711 56.5947C30.2918 56.5218 28.8302 56.3468 27.4217 55.96C26.0336 55.5787 24.53 54.9467 23.3221 53.8525C22.0891 52.7357 21.3076 51.2679 20.7957 49.8926C20.2764 48.4973 19.9709 47.0259 19.7869 45.7305C19.6017 44.426 19.531 43.2345 19.5057 42.3721C19.4929 41.9386 19.492 41.5821 19.494 41.3301C19.4949 41.2042 19.4962 41.1038 19.4979 41.0322C19.4987 40.9964 19.5001 40.9674 19.5008 40.9463C19.5011 40.936 19.5015 40.9275 19.5018 40.9209V40.9072C19.5036 40.9067 19.5693 40.909 21.9998 41L19.5018 40.9063C19.5535 39.5266 20.7139 38.4503 22.0936 38.502C23.4727 38.5536 24.5476 39.7128 24.4969 41.0918L24.4988 41.0928C24.4988 41.0943 24.498 41.0966 24.4979 41.0996C24.4976 41.109 24.4974 41.1259 24.4969 41.1494C24.4958 41.1965 24.4947 41.2708 24.494 41.3691C24.4924 41.5668 24.493 41.8605 24.5037 42.2246C24.5252 42.9575 24.5859 43.9557 24.7381 45.0273C24.8916 46.1083 25.1296 47.201 25.4822 48.1484C25.8422 49.1156 26.2616 49.7698 26.6785 50.1475C27.0886 50.5188 27.7684 50.8702 28.7459 51.1387C29.703 51.4016 30.7893 51.5428 31.8553 51.6035C32.9123 51.6637 33.8889 51.6416 34.6033 51.6035C34.9584 51.5846 35.2435 51.5613 35.4354 51.5439C35.5311 51.5353 35.6037 51.5283 35.6492 51.5234C35.6718 51.521 35.6881 51.5196 35.6971 51.5186C35.6991 51.5183 35.7007 51.5177 35.702 51.5176C36.6372 51.4054 37.556 51.8289 38.0789 52.6123L38.0838 52.6182C38.0907 52.6282 38.103 52.6472 38.1209 52.6729C38.1567 52.7242 38.2147 52.8051 38.2928 52.9121C38.4494 53.1267 38.688 53.4433 39.0008 53.8272C39.6293 54.5985 40.5414 55.6235 41.6727 56.6416C44.0039 58.7397 46.9202 60.4999 49.9998 60.5C53.0359 60.5 55.6838 58.7808 57.7322 56.7324C58.731 55.7337 59.5156 54.7266 60.0496 53.9678C60.315 53.5906 60.5148 53.2806 60.6443 53.0713C60.7088 52.9671 60.7553 52.8879 60.784 52.8389C60.7983 52.8145 60.8082 52.7971 60.8133 52.7881C60.8158 52.7836 60.817 52.7806 60.8172 52.7803V52.7813C61.3232 51.875 62.3368 51.3752 63.3641 51.5264H63.3631C63.3648 51.5266 63.3678 51.5268 63.3719 51.5273C63.3823 51.5288 63.4003 51.5318 63.4256 51.5352C63.4766 51.5419 63.5576 51.5521 63.6639 51.5645C63.8767 51.5893 64.1919 51.6226 64.5838 51.6533C65.3729 51.7152 66.4499 51.7657 67.6131 51.7236C68.7862 51.6812 69.9795 51.5464 71.0272 51.2695C72.0952 50.9872 72.8379 50.6027 73.2859 50.1807C73.7095 49.7816 74.1305 49.1054 74.491 48.1279C74.8441 47.1706 75.0848 46.0743 75.242 44.9951C75.3979 43.9247 75.4633 42.9302 75.4891 42.2012C75.5019 41.8389 75.5039 41.5471 75.5037 41.3506C75.5036 41.2524 75.5035 41.1777 75.5027 41.1309C75.5024 41.1078 75.502 41.0914 75.5018 41.082C75.5017 41.0773 75.5008 41.0743 75.5008 41.0732Z"}))

(def nose-ten
  (make-nose {:path "M27.5 61C27.5 54.9206 29.4522 50.0028 31.9014 45.2334C34.4095 40.3492 37.2363 35.9326 39.6924 30.0381C40.2235 28.7638 41.6875 28.1614 42.9619 28.6924C44.2362 29.2235 44.8386 30.6875 44.3076 31.9619C41.7637 38.0671 38.5905 43.1509 36.3486 47.5166C34.0478 51.9971 32.5 56.0794 32.5 61C32.5 62.1371 33.2991 63.4015 36.2354 64.5674C39.0634 65.6902 43.0084 66.3248 47.1836 66.6318C51.3117 66.9353 55.4645 66.9064 58.6016 66.7988C60.1659 66.7451 61.4687 66.6714 62.377 66.6123C62.8305 66.5827 63.1853 66.5566 63.4248 66.5381C63.5444 66.5288 63.6354 66.5216 63.6953 66.5166C63.7251 66.5141 63.7475 66.5129 63.7617 66.5117C63.7688 66.5111 63.7743 66.51 63.7773 66.5097C63.7788 66.5096 63.7798 66.5098 63.7803 66.5097L64.0361 66.5C65.3031 66.5168 66.3765 67.4909 66.4902 68.7803C66.6116 70.1556 65.5951 71.3689 64.2197 71.4902L64 69C64.2104 71.384 64.219 71.4858 64.2188 71.4902H64.2168C64.2152 71.4903 64.2126 71.491 64.21 71.4912C64.2048 71.4916 64.1975 71.4924 64.1885 71.4931C64.17 71.4947 64.1436 71.4971 64.1094 71.5C64.0407 71.5057 63.9406 71.5134 63.8115 71.5234C63.553 71.5434 63.1769 71.5715 62.7012 71.6025C61.7501 71.6645 60.3963 71.7392 58.7734 71.7949C55.5356 71.906 51.1881 71.9396 46.8164 71.6181C42.4918 71.3001 37.9365 70.6222 34.3896 69.2138C30.951 67.8484 27.5 65.3628 27.5 61Z"}))

(def nose-eleven
  (make-nose {:path "M67.4736 40.9141C68.6258 40.1534 70.1767 40.4708 70.9375 41.623C76.156 49.5278 75.5359 56.8754 72.7275 62.667C70.0007 68.2901 65.2733 72.369 62.2109 74.3545C58.8607 76.5265 54.3292 77.5 49.9912 77.5C45.6486 77.5 41.0942 76.5246 37.6806 74.3711C34.4067 72.3056 29.9208 67.8978 27.248 62.21C24.528 56.4214 23.6215 49.1179 28.0175 41.7227C28.723 40.5358 30.2574 40.1451 31.4443 40.8506C32.6311 41.5561 33.0209 43.0905 32.3154 44.2773C28.9607 49.9206 29.5801 55.4172 31.7724 60.083C34.0121 64.8493 37.8256 68.5509 40.3486 70.1426C42.7318 71.6461 46.2752 72.5 49.9912 72.5C53.7119 72.5 57.2005 71.6443 59.4912 70.1592C62.0696 68.4875 66.0245 65.0304 68.2285 60.4853C70.3508 56.1087 70.9098 50.6557 66.7646 44.377C66.0043 43.2248 66.3217 41.6748 67.4736 40.9141Z"}))

(def nose-twelve
  (make-nose {:path "M69.2504 19.6153C70.5674 19.2013 71.971 19.933 72.3851 21.25C76.3342 33.8073 77.8248 42.6884 77.807 50.1123C77.7892 57.56 76.2496 63.3837 74.3998 69.7022C73.1647 73.9207 69.3937 76.7048 65.1762 78.4043C60.8828 80.1343 55.6107 80.9676 50.4056 80.9785C45.1977 80.9894 39.8682 80.1767 35.4535 78.4619C31.1073 76.7737 27.2059 74.0258 25.6576 69.8731C20.6341 56.3993 21.5837 44.3701 27.5805 21.3692C27.9288 20.0333 29.2943 19.233 30.6303 19.5811C31.9663 19.9294 32.7677 21.2948 32.4193 22.6309C26.4815 45.4056 25.8803 56.1596 30.3422 68.127C31.1652 70.3343 33.4902 72.3359 37.264 73.8018C40.9697 75.2411 45.6551 75.9884 50.3949 75.9785C55.1374 75.9686 59.7469 75.2011 63.307 73.7666C66.9428 72.3016 68.9982 70.3563 69.601 68.2979C71.4265 62.0625 72.7909 56.8047 72.807 50.1006C72.8231 43.3724 71.4774 35.03 67.6156 22.75C67.2014 21.4329 67.9333 20.0295 69.2504 19.6153Z"}))

(def nose-thirteen
  (make-nose {:path "M34.7057 23.0067C35.2076 21.8435 36.5185 21.2264 37.7526 21.6161C39.0691 22.032 39.7993 23.4363 39.3834 24.7528V24.7548C39.3829 24.7565 39.3817 24.7598 39.3805 24.7635C39.378 24.7713 39.3738 24.7837 39.3688 24.7997C39.3587 24.8317 39.3436 24.8799 39.3239 24.9432C39.2842 25.0703 39.2263 25.259 39.152 25.5008C39.0033 25.9845 38.7909 26.6819 38.5387 27.5331C38.0336 29.2378 37.3694 31.5512 36.7311 33.994C36.0908 36.4443 35.4859 38.9892 35.0905 41.1669C34.8926 42.2562 34.7542 43.2195 34.6862 44.0135C34.6147 44.8476 34.6363 45.3389 34.6754 45.5565C34.834 46.4377 34.5091 47.3367 33.8239 47.913C28.9641 51.9998 27.259 55.126 26.901 57.2997C26.5687 59.3177 27.3261 61.0052 28.819 62.5409C30.3602 64.1262 32.5238 65.3542 34.4283 66.204C35.3596 66.6195 36.1845 66.9255 36.7721 67.1258C37.0648 67.2257 37.2962 67.2989 37.4498 67.3456C37.5266 67.3689 37.5844 67.3852 37.6198 67.3954C37.6372 67.4004 37.6495 67.4033 37.6559 67.4051L37.6588 67.4061C38.2314 67.5625 38.7293 67.918 39.0641 68.4081L39.0865 68.4393C39.1115 68.474 39.1545 68.5325 39.2145 68.6112C39.3348 68.7692 39.5241 69.0077 39.778 69.2997C40.2881 69.8865 41.0471 70.6747 42.025 71.4598C43.9981 73.0437 46.7101 74.4998 49.9996 74.4999C53.2572 74.4999 55.6863 73.0708 57.3639 71.5546C58.2037 70.7955 58.8316 70.0329 59.2457 69.4657C59.4515 69.1838 59.6017 68.9553 59.6949 68.8055C59.7414 68.7309 59.7737 68.6764 59.7916 68.6454L59.8043 68.6229C60.087 68.1037 60.5429 67.7037 61.0885 67.4901L61.3278 67.41C61.3291 67.4096 61.3311 67.4088 61.3336 67.4081C61.3422 67.4056 61.3575 67.4015 61.3785 67.3954C61.4208 67.383 61.4872 67.363 61.5758 67.3358C61.7536 67.2813 62.0195 67.1976 62.3541 67.0839C63.025 66.8559 63.9646 66.5118 65.024 66.0526C67.1883 65.1146 69.6601 63.7778 71.4176 62.1005C73.1501 60.4469 73.8919 58.7817 73.5319 56.9559C73.1322 54.9305 71.2516 51.9246 65.7145 48.0477C64.8003 47.4077 64.4208 46.2393 64.7848 45.1844C65.0266 44.4837 65.079 42.9789 64.7643 40.6913C64.4669 38.5296 63.9029 36.0561 63.2662 33.6815C62.6324 31.3175 61.9411 29.1056 61.4069 27.4813C61.1402 26.6706 60.9136 26.0091 60.7545 25.5526C60.6751 25.3246 60.6122 25.1478 60.5699 25.0292C60.5488 24.9699 60.5327 24.9247 60.5221 24.8954C60.5169 24.881 60.5128 24.8699 60.5104 24.8631C60.5093 24.8601 60.5089 24.8577 60.5084 24.8563L60.5074 24.8553C60.0352 23.5579 60.7042 22.1225 62.0016 21.6503C63.2989 21.178 64.7333 21.8472 65.2057 23.1444L65.2067 23.1454V23.1464L65.2115 23.161C65.2149 23.1702 65.2201 23.1832 65.2262 23.2001C65.2386 23.2345 65.2568 23.2848 65.2799 23.3495C65.326 23.4788 65.3925 23.667 65.4762 23.9071C65.6436 24.3875 65.8799 25.0767 66.1569 25.9188C66.7099 27.6004 67.4302 29.9059 68.0953 32.3866C68.7576 34.8565 69.3797 37.555 69.7174 40.0096C69.9405 41.6313 70.0728 43.3633 69.9098 44.9139C74.9527 48.6944 77.7202 52.354 78.4371 55.9872C79.2539 60.1271 77.2805 63.4168 74.8698 65.7176C72.4838 67.9947 69.3838 69.6127 67.0123 70.6405C65.8038 71.1643 64.7337 71.5562 63.9625 71.8182C63.8435 71.8587 63.7302 71.8922 63.6256 71.9266C63.5249 72.0752 63.4116 72.2389 63.2838 72.4139C62.7147 73.1934 61.8631 74.2271 60.7164 75.2635C58.421 77.3382 54.8497 79.4999 49.9996 79.4999C45.1819 79.4998 41.394 77.3651 38.8942 75.3583C37.6357 74.348 36.665 73.3397 36.0045 72.5799C35.8066 72.3523 35.6357 72.1453 35.4918 71.9657C35.3889 71.932 35.2763 71.8987 35.1578 71.8583C34.4573 71.6194 33.4875 71.2595 32.3912 70.7704C30.2401 69.8105 27.4159 68.2705 25.234 66.0262C23.0043 63.7326 21.3019 60.5284 21.9674 56.4872C22.567 52.8468 25.0183 49.0166 29.6403 44.9188C29.642 44.4768 29.6661 44.0271 29.7037 43.5878C29.7899 42.5817 29.9577 41.4508 30.1715 40.2733C30.5995 37.9166 31.24 35.2341 31.8942 32.7303C32.5503 30.2191 33.2299 27.851 33.7448 26.1131C34.0024 25.2435 34.2198 24.5297 34.3727 24.0321C34.4491 23.7835 34.5088 23.5883 34.5504 23.4549C34.5712 23.3883 34.5873 23.3366 34.5983 23.3016C34.6037 23.2842 34.6081 23.2708 34.611 23.2616C34.6124 23.257 34.6141 23.2533 34.6149 23.2508C34.6152 23.2497 34.6156 23.2486 34.6158 23.2479V23.2469L34.7057 23.0067Z"}))

;; -------------------------
;; Mouth renderers
;; -------------------------

(defn make-mouth
  "Create a mouth renderer from declarative layered paths.
   Supports explicit z-order via :z (lower = back, higher = front)."
  [{:keys [layers]}]

  ;; Pre-sort once at definition time (cheaper than per-render)
  (let [sorted-layers
        (sort-by (fn [{:keys [z]}] (or z 0)) layers)]

    (fn mouth-renderer [{:keys [lip-color]}]
      (asset-root

       (for [{:keys [path role fill]} sorted-layers]
         ^{:key path}
         [:path
          {:d path
           :fill
           (case role
             :lips lip-color
             :teeth "white"
             :dark "black"
             :fixed (or fill "black")
             "black")}])))))

(def mouth-001
  (make-mouth
   {:layers
    [{:path "M84 46V53H17V46H84Z"
      :role :lips}]}))

(def mouth-002
  (make-mouth
   {:layers
    [{:path "M50 44C40.5 39 30.1296 40.9989 10.5 42.5C36 66 63 67.5 90 42.5C69.2151 40.2412 60 40.5 50 44Z"
      :role :lips}]}))

(def mouth-003
  (make-mouth
   {:layers
    [{:path "M8.4043 39.0479C10.9886 42.8925 16.4998 46.1506 24.2871 48.3945C31.9414 50.6001 41.2075 51.6537 50.4834 51.5625C59.7603 51.4713 68.8606 50.237 76.1816 47.9902C83.6956 45.6842 88.5631 42.5505 90.4688 39.25L96.5312 42.75C93.2407 48.4493 86.1484 52.2533 78.2363 54.6816C70.1313 57.1691 60.3381 58.4662 50.5527 58.5625C40.7664 58.6588 30.8002 57.5561 22.3496 55.1211C14.0321 52.7244 6.56519 48.8575 2.5957 42.9521L8.4043 39.0479Z"
      :role :lips}]}))

(def mouth-004
  (make-mouth
   {:layers
    [{:path "M84.9426 33.4295C88.5891 35.3782 91.5458 37.1333 93.8987 39.537C96.2975 41.9877 97.9583 44.9918 99.2883 49.2733L95.468 50.4598C94.5576 47.529 93.5357 45.4463 92.2913 43.7909C90.6192 45.547 88.421 46.9335 86.0295 48.0428C83.0743 49.4136 79.5609 50.4849 75.7522 51.3045C68.1322 52.9444 58.9534 53.6579 49.8381 53.5623C40.7172 53.4667 31.5044 52.559 23.802 50.8807C19.952 50.0418 16.4049 48.994 13.4045 47.7206C11.4063 46.8724 9.53508 45.8761 7.95825 44.6922C6.99085 46.1936 6.16296 48.0372 5.4104 50.4598L1.59009 49.2733C2.92008 44.9918 4.57999 41.9877 6.97876 39.537C9.3317 37.1331 12.289 35.3784 15.9358 33.4295L17.8206 36.9569C15.9591 37.9517 14.4028 38.8344 13.0745 39.7176C13.8979 40.2317 14.9139 40.7572 16.1389 41.2772C18.6189 42.3298 21.7206 43.2626 25.2922 44.0409C32.4334 45.5969 41.1586 46.4705 49.9124 46.5623C58.6718 46.6542 67.3061 45.9615 74.2795 44.4608C77.7674 43.7102 80.7466 42.7775 83.0842 41.6932C84.8756 40.8623 86.1476 40.0076 86.9924 39.1961C85.851 38.4834 84.5532 37.756 83.0579 36.9569L84.9426 33.4295Z"
      :role :lips}]}))

(def mouth-005
  (make-mouth
   {:layers
    [     ;; Mouth interior
     {:path "M83.5859 52C73.2686 60.4671 65.2736 64.5 50.5 64.5C35.6198 64.5 26.0722 60.6672 15.6484 52H83.5859Z"
      :role :dark}

     ;; Teeth
     {:path "M94.5 42.5L94.0195 42.9277C90.1469 46.3789 86.7562 49.3983 83.5859 52H15.6484C12.4122 49.3091 9.09075 46.1531 5.5 42.5H94.5Z"
      :role :teeth}

     ;; Lips
     {:path "M94.5 40C95.5374 40 96.4667 40.6409 96.8359 41.6104C97.2051 42.5797 96.9375 43.6761 96.1631 44.3662C87.8338 51.7882 81.4846 57.5053 74.7334 61.2959C67.8383 65.1672 60.6045 67 50.5 67C40.4388 67 32.5669 65.2961 25.2236 61.5039C17.9435 57.7443 11.3434 52.0119 3.71677 44.2529C3.0107 43.5346 2.80486 42.4621 3.19431 41.5332C3.58379 40.6044 4.49277 40 5.49998 40H94.5ZM11.5879 45C17.2529 50.4097 22.2546 54.3421 27.5185 57.0605C34.0111 60.4134 41.0612 62 50.5 62C59.8955 62 66.2581 60.321 72.2861 56.9365C77.191 54.1826 81.9226 50.2779 87.915 45H11.5879Z"
      :role :lips}]}))

(def mouth-006
  (make-mouth
   {:layers
    [{:path "M100 41C61.7502 44.0479 39.8688 44.1197 0 41C0 41 18 54.5 50.5 54.5C83 54.5 100 41 100 41Z"
      :role :dark}]}))

(def mouth-007
  (make-mouth
   {:layers
    [{:path "M86 49.5C67.5 69 31 68.5 15.5 49.5C33.5 35.5 68 35.5 86 49.5Z"
      :role :lips}]}))

(def mouth-008
  (make-mouth
   {:layers
    [{:path "M50.4995 42C60.1175 42 65.6602 46.1752 70.9409 48.6182C73.6285 49.8615 76.492 50.8421 80.2339 51.1104C84.0094 51.381 88.8379 50.9372 95.4302 49.1094L97.0337 54.8906C89.9638 56.8508 84.4317 57.4263 79.8052 57.0947C75.1452 56.7607 71.5646 55.5171 68.4224 54.0635C62.0433 51.1124 58.3813 48 50.4995 48C42.5662 48.0001 37.9417 51.3183 30.979 54.3232C27.5819 55.7893 23.7974 57.0499 19.1655 57.3525C14.5398 57.6547 9.24094 56.9915 2.78564 54.8467L4.67822 49.1533C10.5388 51.1005 15.0569 51.6082 18.7749 51.3652C22.4868 51.1227 25.5738 50.1214 28.6021 48.8145C34.4899 46.2733 40.9334 42.0001 50.4995 42Z"
      :role :lips}]}))

(def mouth-009
  (make-mouth
   {:layers
    [{:path "M58.1982 37.7277C61.7965 36.8746 65.4421 37.0885 69.2422 38.1144C76.6571 40.1162 85.0966 45.3558 95.6807 52.5148L92.3193 57.4855C81.579 50.2208 73.9604 45.6024 67.6777 43.9064C64.6292 43.0835 62.0158 42.9886 59.582 43.5655C57.1393 44.1447 54.6562 45.4539 51.9551 47.7755C50.8849 48.695 49.3185 48.7447 48.1924 47.8946C45.1957 45.632 42.4735 44.3604 39.833 43.8185C37.2028 43.2787 34.4652 43.4238 31.375 44.2648C25.0182 45.9948 17.5656 50.5317 7.16895 57.4933L3.83105 52.507C14.0666 45.6533 22.3313 40.5071 29.7998 38.4747C33.6223 37.4345 37.3255 37.1791 41.04 37.9415C44.0737 38.5642 46.9884 39.841 49.8867 41.7491C52.5475 39.7737 55.2851 38.4183 58.1982 37.7277Z"
      :role :lips}]}))

(def mouth-010
  (make-mouth
   {:layers
    [{:path "M78.5205 29.3203C82.1163 36.0402 84.7029 41.8134 86.5049 48.7725C88.3001 55.7055 89.2897 63.7118 89.8135 74.8838L84.8193 75.1172C84.3545 65.2043 83.5229 58.0414 82.1426 52H19.1729C17.7926 58.0414 16.9619 65.2043 16.4971 75.1172L11.5029 74.8838C12.0268 63.7118 13.0163 55.7055 14.8115 48.7725C16.6136 41.8134 19.2001 36.0402 22.7959 29.3203L27.2041 31.6797C24.654 36.4454 22.6924 40.602 21.1699 45H80.1465C78.624 40.602 76.6615 36.4455 74.1113 31.6797L78.5205 29.3203Z"
      :role :lips}]}))

(def mouth-011
  (make-mouth
   {:layers
    [     ;; Interior (back)
     {:z 0
      :path "M27.841 49.8167C44.9141 49.0411 55.7825 49.0741 72.3663 49.8274C78.0317 58.0061 68.9132 59.0911 68.9132 59.0911C54.1407 61.3704 45.8606 61.2431 31.088 59.0911C31.0271 59.0804 22.8372 57.6302 27.841 49.8167Z"
      :role :dark}

     ;; Teeth (middle)
     {:z 1
      :path "M31.0889 45.8189C44.526 33.9695 54.4799 33.4955 68.9131 45.8189C70.4213 47.3152 71.5486 48.6458 72.3672 49.8277C55.7832 49.0743 44.9148 49.0414 27.8418 49.817C28.5983 48.6357 29.6556 47.308 31.0889 45.8189Z"
      :role :teeth}

     ;; Lips (front)
     {:z 2
      :path "M49.6079 34.7543C56.0879 34.6901 62.4472 37.8136 69.5249 43.7181L70.2124 44.2982L70.2691 44.347L70.3218 44.3998C73.4025 47.456 75.1602 50.0429 75.8618 52.2982C76.606 54.6903 76.1439 56.6854 74.9448 58.1605C73.8519 59.505 72.3158 60.209 71.2388 60.5765C70.6749 60.7689 70.1705 60.8913 69.8042 60.9662C69.62 61.0038 69.4675 61.0307 69.356 61.0482C69.3001 61.057 69.2538 61.063 69.2192 61.0677C69.2156 61.0682 69.2119 61.0683 69.2085 61.0687C54.2274 63.3796 45.7472 63.248 30.8003 61.0707L30.7739 61.0668L30.7476 61.0619L31.0884 59.0912C30.7471 61.0619 30.7446 61.0619 30.7446 61.0619L30.7417 61.0609C30.7417 61.0609 30.7379 61.0603 30.7358 61.0599C30.7316 61.0592 30.7267 61.058 30.7212 61.057C30.7097 61.0549 30.695 61.0524 30.6782 61.0492C30.6448 61.0427 30.6012 61.0342 30.5483 61.0228C30.4423 61 30.2978 60.9664 30.1245 60.9203C29.7801 60.8285 29.3076 60.6832 28.7808 60.4642C27.7656 60.0423 26.3536 59.2672 25.3608 57.892C24.2944 56.4146 23.8744 54.4676 24.5474 52.1371C25.1893 49.9142 26.8065 47.3842 29.648 44.432L29.7046 44.3734L29.7661 44.3197C36.6147 38.2803 42.9182 34.8206 49.6079 34.7543ZM49.647 38.7543C44.4088 38.8063 39.0344 41.4918 32.4741 47.264C29.8807 49.9698 28.773 51.9248 28.3911 53.2474C28.0378 54.4713 28.302 55.1315 28.604 55.5502C28.9797 56.0706 29.6205 56.4808 30.3159 56.7699C30.6443 56.9064 30.9422 56.9987 31.1538 57.055C31.2583 57.0829 31.3392 57.1011 31.3882 57.1117C31.3978 57.1137 31.4065 57.1151 31.4136 57.1166C45.9851 59.2375 54.0626 59.3589 68.6079 57.1146L68.6431 57.1097L68.6704 57.1058H68.6685C68.6685 57.1058 68.6716 57.1054 68.6753 57.1049C68.6852 57.1035 68.7052 57.1015 68.7339 57.097C68.7915 57.088 68.8837 57.0715 69.0024 57.0472C69.2425 56.9981 69.5778 56.9173 69.9468 56.7914C70.7361 56.522 71.4402 56.1293 71.8403 55.6371C72.1343 55.2755 72.418 54.6938 72.0425 53.4867C71.6265 52.1496 70.4087 50.1296 67.5493 47.2845C60.5014 41.2804 54.8863 38.7023 49.647 38.7543Z"
      :role :lips}]}))

(def mouth-012
  (make-mouth
   {:layers
    [{:path "M82 46.5786C65.6596 25.8071 34.3404 25.8071 18 46.5785V54.0444C33.7836 74.7871 67.0102 75.2231 82 54V46.5786Z"
      :role :lips}]}))

(def mouth-013
  (make-mouth
   {:layers
    [     ;; Interior (back)
     {:z 0
      :path "M16.5 37C42.6815 44.0055 56.4845 45.1328 85 37.5L90 45.5C69.004 63.1962 34.9991 62.4986 12 45.5L16.5 37Z"
      :role :dark}

     ;; Teeth (middle)
     {:z 1
      :path "M32 40C44.8423 42.8965 55.2591 43.2875 69 40.4899V56.3894C57.2066 60.1833 44.0785 59.807 32 55.4888V40Z"
      :role :teeth}

     ;; Lips (front)
     {:z 2
      :path "M16.5898 35.0684C29.6343 38.5587 39.4445 40.5407 49.4873 40.7393C59.5188 40.9376 69.8989 39.3577 84.0557 35.5684L85.4854 35.1855L92.1885 45.9111L90.8623 47.0293C69.0616 65.4037 34.0217 64.5784 10.3848 47.1084L9 46.085L15.0508 34.6562L16.5898 35.0684ZM14.1582 44.8896C35.9786 60.0851 67.0819 60.6208 86.9404 45.0615L83.6562 39.8076C70.0079 43.3816 59.5986 44.9407 49.4082 44.7393C39.2906 44.5392 29.4969 42.6063 17.0967 39.3389L14.1582 44.8896Z"
      :role :lips}]}))

(def mouth-014
  (make-mouth
   {:layers
    [{:path "M87.9893 32.2119C84.1238 37.2854 82.234 41.6658 81.957 45.8203C81.6818 49.9493 82.9814 54.149 86.0762 58.9102L82.7217 61.0898C80.3968 57.513 78.8678 54.0235 78.2422 50.5H21.6572C21.0316 54.0235 19.5026 57.5131 17.1777 61.0898L13.8232 58.9102C16.918 54.149 18.2176 49.9493 17.9424 45.8203C17.6654 41.6658 15.7747 37.2855 11.9092 32.2119L15.0908 29.7881C18.6815 34.5009 20.9332 38.9829 21.6914 43.5H78.208C78.9662 38.9829 81.2171 34.5008 84.8076 29.7881L87.9893 32.2119Z"
      :role :lips}]}))

(def mouth-015
  (make-mouth
   {:layers
    [{:path "M49.6195 36.7743C40.1195 27.7743 33.1186 37.5001 14.1187 39.0001C14.1187 39.0001 12.567 43.5103 13.1186 43.9999C31.5374 70.7508 67.4787 72.0783 87.1195 43.9999C87.6682 43.511 86.1186 39.9999 86.1186 39.9999C69.6176 37.9999 59.6195 27.2743 49.6195 36.7743Z"
      :role :lips}]}))

(def mouth-016
  (make-mouth
   {:layers
    [{:path "M50 35.5C32.9488 35.5 31.4868 43.3962 12.5 40.9123C12.5 40.9123 7.89085 45.0052 8.50006 45.5C22.8449 76.5378 75.8054 76.3795 91.5 46C92.106 45.5058 87 40.9123 87 40.9123C68.7735 42.8909 67.0512 35.5 50 35.5Z"
      :role :lips}]}))

(def mouth-017
  (make-mouth
   {:layers
    [     ;; Lips (bottom)
     {:path "M10.9999 36.0001C41.7894 31.9537 58.8763 32.0442 88.9999 36.0001C89.6269 37.8674 90.0204 39.2895 90.2488 40.6234C90.4912 42.0394 90.5476 43.356 90.4999 45C70.4999 75 27.9999 73.5 9.99989 45C9.9208 43.2627 9.89909 41.8951 9.99989 40.6234C10.1205 39.1013 10.4167 37.7167 10.9999 36.0001Z"
      :role :lips}

     ;; Teeth
     {:path "M10.5 40C41.8911 43.0347 59.2757 42.9666 90 40C70.4702 57.008 29.5 56.5 10.5 40Z"
      :role :teeth}]}))

(def mouth-018
  (make-mouth
   {:layers
    [{:z 0
      :path "M20 46C29.7981 45.7405 38.5 32 50.5 32C60.2897 31.652 71.2098 45.4034 81 46V48C74.5389 48.5941 62.5 63 50.5 63C40.3004 63.3047 25.4921 48.5071 20 48V46Z"
      :role :dark}

     {:z 1
      :path "M50.5 32.0004C60.2897 31.6523 71.2098 45.4038 81 46.0004V48.0004H20V46.0004C29.7981 45.7408 38.5 32.0004 50.5 32.0004Z"
      :role :teeth}

     {:z 2
      :path "M50.5 29.0014C53.6125 28.9158 56.611 29.9276 59.3379 31.2621C62.1007 32.6142 64.8506 34.4323 67.4199 36.1537C70.057 37.9206 72.5047 39.586 74.8975 40.8676C77.2957 42.1521 79.3652 42.8945 81.1826 43.0053L84 43.1772V50.7367L81.2744 50.9877C80.4721 51.0616 79.0679 51.6675 76.8213 53.1156C74.6364 54.5241 72.3364 56.2531 69.5332 58.1908C64.273 61.8271 57.5484 66.0004 50.5 66.0004V65.9985C47.2914 66.0727 43.9835 64.9924 40.9385 63.5766C37.825 62.1288 34.6978 60.1931 31.8359 58.311C28.8723 56.3619 26.3581 54.5859 24.0557 53.143C22.9357 52.4412 21.9784 51.8915 21.1797 51.5112C20.3375 51.1102 19.8846 51.0026 19.7246 50.9877L17 50.7358V43.0785L19.9209 43.0014C21.6849 42.9546 23.5731 42.2941 25.7529 41.0815C27.9546 39.8566 30.1688 38.2386 32.6914 36.4535C37.491 33.0572 43.4117 29.0004 50.5 29.0004V29.0014Z"
      :role :lips}]}))

(def mouth-019
  (make-mouth
   {:layers
    [{:z 0
      :path "M24.4999 33.5C31.9999 35.5003 68 36.5 78.4997 34C88.5 34 98.0001 51.9996 82.9996 57.9999C67.9992 64.0002 30.5001 63.9996 17.9997 57.9999C5.4993 52.0002 9.49997 34 24.4999 33.5Z"
      :role :teeth}

     {:z 1 :path "M34.5 60H28.5V36.5H34.5V60Z" :role :fixed}
     {:z 1 :path "M53 60H47V36.5H53V60Z" :role :fixed}
     {:z 1 :path "M72 60H66V36.5H72V60Z" :role :fixed}

     {:z 2
      :path "M25.273 30.6016C26.8372 31.0187 30.2238 31.4434 34.8433 31.7812C39.3709 32.1124 44.8456 32.3455 50.4254 32.4385C56.0056 32.5315 61.6596 32.4838 66.5504 32.2607C71.5042 32.0348 75.4779 31.6362 77.8053 31.082L78.148 31H78.4996C81.9004 31 85.0389 32.5175 87.4918 34.6357C89.9548 36.7628 91.9222 39.6537 92.9713 42.8008C94.0225 45.9544 94.2008 49.5367 92.7974 52.8799C91.3724 56.2747 88.4763 59.0401 84.1138 60.7852C76.0624 64.0058 62.4626 65.5001 49.5621 65.5C43.0488 65.5 36.5827 65.1193 30.9156 64.3477C25.3122 63.5846 20.2535 62.4088 16.7017 60.7041C9.0978 57.0544 6.39117 49.5803 8.02498 42.9678C9.66066 36.3481 15.5625 30.7966 24.4 30.502L24.8443 30.4873L25.273 30.6016Z"
      :role :lips}]}))

(def mouth-020
  (make-mouth
   {:layers
    [{:path "M68.1807 63.9922C57.0982 64.9997 42.9672 65.2665 32.2627 63.9854L32.7373 60.0146C43.07 61.2513 56.902 61.0003 67.8193 60.0078L68.1807 63.9922Z"
      :role :lips}

     {:path "M87.1246 36.4999C86.6247 34.4999 87.6249 31.0004 90.1246 32.4999C92.6246 33.9998 95.1246 36.9999 95.6246 40.9999C96.1246 44.9998 93.6256 46.4996 92.1256 43.9999C91.7688 43.4053 91.3258 42.7832 90.8531 42.1522C67.8787 48.3841 34.0785 48.4359 9.10995 42.37C8.6988 42.9263 8.3162 43.4739 8.00058 43.9999C6.50056 46.4998 4.00058 44.9998 4.50058 40.9999C5.00061 36.9999 7.50058 33.9998 10.0006 32.4999C12.5003 31.0004 13.5005 34.4999 13.0006 36.4999C12.955 36.6822 12.8874 36.8724 12.8033 37.0702C35.8718 42.2092 66.079 42.1318 87.2477 36.8885C87.1975 36.7553 87.156 36.6256 87.1246 36.4999Z"
      :role :lips}]}))

(def mouth-021
  (make-mouth
   {:layers
    [{:path "M42.2601 28.3672C47.2414 27.2746 53.1324 28.5737 59.2757 33.0811L55.7259 37.919C50.6167 34.1704 46.4559 33.5894 43.5462 34.2276C40.5916 34.8757 38.4933 36.8598 37.5501 39.0938C36.6031 41.3372 36.8906 43.5639 38.2601 45.0909C41.1895 48.357 45.9688 46.782 49.8255 47.2022L49.4837 50.3389L49.8255 53.4825C45.9675 53.9028 41.1906 52.3264 38.2601 55.5938C36.8906 57.1207 36.6031 59.3475 37.5501 61.5909C38.4933 63.8248 40.5916 65.809 43.5462 66.4571C46.4559 67.0952 50.6168 66.5142 55.7259 62.7657L59.2757 67.6036C53.1324 72.1109 47.2414 73.41 42.2601 72.3174C37.324 71.2345 33.6915 67.8768 32.0228 63.9239C30.3579 59.98 30.5775 55.1736 33.7933 51.5879C34.193 51.1423 34.628 50.7261 35.0989 50.3418C34.6282 49.9577 34.1928 49.5422 33.7933 49.0967C30.5775 45.511 30.3579 40.7046 32.0228 36.7608C33.6915 32.8078 37.324 29.4501 42.2601 28.3672Z"
      :role :lips}]}))

;; -------------------------
;; Glasses Renderers
;; -------------------------

(defn glasses-001 [{:keys [frame-color]}]
  (asset-root
   [:path
    {:d "M41.9258 39.0615C43.2147 39.4435 44.2653 39.8969 45.1074 40.6514C45.9588 41.4142 46.4597 42.362 46.8926 43.4424L47.0176 43.7539L46.9971 44.0889C46.8992 45.7455 46.7842 47.1668 46.6504 48.5H53.3486C53.2148 47.1668 53.0998 45.7455 53.002 44.0889L52.9814 43.7539L53.1064 43.4424C53.5393 42.362 54.0402 41.4142 54.8916 40.6514C55.7337 39.8969 56.7843 39.4435 58.0732 39.0615L58.2812 39H77.0557L77.1133 39.0039C79.0508 39.1516 80.55 39.4791 81.748 40.2256C82.9803 40.9935 83.704 42.0864 84.334 43.3164L84.5166 43.6719L84.4971 44.0703C84.2648 48.9975 84.0081 51.9154 83.4922 57.1475L83.4697 57.374L83.3809 57.584C82.7537 59.0668 82.0568 60.2595 80.9961 61.0996C79.9192 61.9525 78.6483 62.2998 77.1904 62.4873L77.0947 62.5H59.7344L59.4854 62.4092C58.0908 61.9006 56.8868 61.3581 56.0166 60.5195C55.0778 59.6148 54.6695 58.5128 54.5166 57.2168L54.5146 57.2178C54.194 55.0349 53.9252 53.2466 53.6973 51.5H46.3018C46.0738 53.2466 45.805 55.0349 45.4844 57.2178L45.4824 57.2168C45.3295 58.5128 44.9212 59.6148 43.9824 60.5195C43.1122 61.3581 41.9083 61.9006 40.5137 62.4092L40.2646 62.5H22.9043L22.8086 62.4873C21.3508 62.2998 20.0798 61.9525 19.0029 61.0996C17.9422 60.2595 17.2453 59.0668 16.6182 57.584L16.5293 57.374L16.5068 57.1475C15.9909 51.9154 15.7342 48.9975 15.502 44.0703L15.4824 43.6719L15.665 43.3164C16.295 42.0864 17.0187 40.9935 18.251 40.2256C19.4491 39.4791 20.9482 39.1516 22.8857 39.0039L22.9434 39H41.7178L41.9258 39.0615ZM23.0713 42C21.3177 42.137 20.4123 42.4136 19.8379 42.7715C19.356 43.0717 18.9749 43.5101 18.5186 44.3389C18.7389 48.8765 18.9861 51.7033 19.4697 56.6172C19.9916 57.808 20.4227 58.3968 20.8662 58.748C21.3074 59.0973 21.9234 59.3404 23.1055 59.5H39.7266C40.9283 59.0477 41.5451 58.7027 41.9014 58.3594C42.2001 58.0714 42.4129 57.6921 42.5098 56.832L42.5127 56.8066L42.5156 56.7822C42.9213 54.0205 43.2364 51.9613 43.4893 49.8242C43.6886 48.139 43.8469 46.4039 43.9795 44.2529C43.669 43.536 43.4086 43.1574 43.1055 42.8857C42.7738 42.5886 42.2681 42.3101 41.2725 42H23.0713ZM58.7266 42C57.7309 42.3101 57.2252 42.5886 56.8936 42.8857C56.5904 43.1574 56.33 43.536 56.0195 44.2529C56.1522 46.4039 56.3104 48.139 56.5098 49.8242C56.7626 51.9613 57.0777 54.0205 57.4834 56.7822L57.4863 56.8066L57.4893 56.832C57.5861 57.6921 57.799 58.0714 58.0977 58.3594C58.4539 58.7027 59.0707 59.0477 60.2725 59.5H76.8936C78.0756 59.3404 78.6916 59.0973 79.1328 58.748C79.5763 58.3968 80.0074 57.808 80.5293 56.6172C81.0129 51.7033 81.2601 48.8765 81.4805 44.3389C81.0241 43.5101 80.643 43.0717 80.1611 42.7715C79.5867 42.4136 78.6813 42.137 76.9277 42H58.7266Z"
     :fill frame-color}]))

(defn shades-001 [{:keys [lens-color]}]
  (asset-root
   [:<>
    ;; Lenses
    [:ellipse {:cx 31.3249 :cy 53.2056
               :rx 15.2846 :ry 11.3588
               :transform "rotate(-16.6435 31.3249 53.2056)"
               :fill lens-color
               :fill-opacity 0.75}]

    [:ellipse {:cx 15.2846 :cy 11.3588
               :rx 15.2846 :ry 11.3588
               :transform "matrix(-0.958105 -0.286416 -0.286416 0.958105 86.3569 46.7004)"
               :fill lens-color
               :fill-opacity 0.75}]

    ;; Frame
    [:path
     {:d "M51.8378 37.7339C57.286 37.7548 61.1139 37.9437 67.3916 38.5005C83.8927 41.0006 89.393 48.0006 87.3916 58.5005L83.2861 56.8579C84.4869 51.033 79.4767 44.6438 71.7128 42.3228C63.6252 39.905 55.6124 42.8174 53.8154 48.8276C53.7487 49.0506 53.6924 49.2755 53.6445 49.5005H46.1396C46.0917 49.2755 46.0354 49.0506 45.9687 48.8276C44.1717 42.8174 36.1589 39.905 28.0712 42.3228C20.3073 44.6438 15.2972 51.033 16.498 56.8579L12.3925 58.5005C10.3911 48.0006 15.8913 41.0005 32.3925 38.5005C38.6702 37.9437 42.4981 37.7548 47.9462 37.7339H51.8378ZM42.3916 39.688V41.0005C45.1564 42.4257 46.3122 43.5519 47.8916 46.0005H51.8925C53.4719 43.5519 54.6276 42.4257 57.3925 41.0005V39.688H42.3916Z"
      :fill "black"}]]))

(defn shades-002 [{:keys [lens-color]}]
  (asset-root
   [:<>
    [:path {:d "M17 45.5C18.1715 43.2127 19.2804 42.2835 23 42H41.5C43.9178 42.7164 44.6985 43.4997 45.5 45.5C45.1961 50.6435 44.7404 53.4597 44 58.5C43.7548 60.6778 42.7566 61.4947 40 62.5H23C20.3034 62.1532 19.1885 61.3103 18 58.5C17.4853 53.2798 17.2306 50.3909 17 45.5Z"
            :fill lens-color
            :fill-opacity 0.25}]
    [:path {:d "M82.999 45.5C81.8275 43.2127 80.7186 42.2835 76.999 42H58.499C56.0813 42.7164 55.3005 43.4997 54.499 45.5C54.8029 50.6435 55.2587 53.4597 55.999 58.5C56.2442 60.6778 57.2425 61.4947 59.999 62.5H76.999C79.6957 62.1532 80.8105 61.3103 81.999 58.5C82.5137 53.2798 82.7685 50.3909 82.999 45.5Z"
            :fill lens-color
            :fill-opacity 0.25}]
    [:path {:d "M41.9258 40.5615C43.2147 40.9435 44.2653 41.3969 45.1074 42.1514C45.9588 42.9142 46.4597 43.862 46.8926 44.9424L47.0176 45.2539L46.9971 45.5889C46.9172 46.9402 46.8256 48.1345 46.7227 49.25H53.2764C53.1734 48.1345 53.0818 46.9402 53.002 45.5889L52.9814 45.2539L53.1064 44.9424C53.5393 43.862 54.0402 42.9142 54.8916 42.1514C55.7337 41.3969 56.7843 40.9435 58.0732 40.5615L58.2812 40.5H77.0557L77.1133 40.5039C79.0508 40.6516 80.55 40.9791 81.748 41.7256C82.9803 42.4935 83.704 43.5864 84.334 44.8164L84.5166 45.1719L84.4971 45.5703C84.4336 46.9177 84.3669 48.1147 84.2949 49.25H87.5C88.4665 49.25 89.25 50.0335 89.25 51C89.25 51.9665 88.4665 52.75 87.5 52.75H84.0381C83.892 54.5143 83.7178 56.3597 83.4922 58.6475L83.4697 58.874L83.3809 59.084C82.7537 60.5668 82.0568 61.7595 80.9961 62.5996C79.9192 63.4525 78.6483 63.7998 77.1904 63.9873L77.0947 64H59.7344L59.4854 63.9092C58.0908 63.4006 56.8868 62.8581 56.0166 62.0195C55.0778 61.1148 54.6695 60.0128 54.5166 58.7168L54.5146 58.7178C54.1775 56.4227 53.8993 54.5753 53.665 52.75H46.334C46.0997 54.5753 45.8215 56.4227 45.4844 58.7178L45.4824 58.7168C45.3295 60.0128 44.9212 61.1148 43.9824 62.0195C43.1122 62.8581 41.9083 63.4006 40.5137 63.9092L40.2646 64H22.9043L22.8086 63.9873C21.3508 63.7998 20.0798 63.4525 19.0029 62.5996C17.9422 61.7595 17.2453 60.5668 16.6182 59.084L16.5293 58.874L16.5068 58.6475C16.2813 56.3597 16.107 54.5143 15.9609 52.75H13C12.0335 52.75 11.25 51.9665 11.25 51C11.25 50.0335 12.0335 49.25 13 49.25H15.7041C15.6321 48.1147 15.5655 46.9177 15.502 45.5703L15.4824 45.1719L15.665 44.8164C16.295 43.5864 17.0187 42.4935 18.251 41.7256C19.4491 40.9791 20.9482 40.6516 22.8857 40.5039L22.9434 40.5H41.7178L41.9258 40.5615ZM23.0713 43.5C21.3177 43.637 20.4123 43.9136 19.8379 44.2715C19.356 44.5717 18.9749 45.0101 18.5186 45.8389C18.7389 50.3765 18.9861 53.2033 19.4697 58.1172C19.9916 59.308 20.4227 59.8968 20.8662 60.248C21.3074 60.5973 21.9234 60.8404 23.1055 61H39.7266C40.9283 60.5477 41.5451 60.2027 41.9014 59.8594C42.2001 59.5714 42.4129 59.1921 42.5098 58.332L42.5127 58.3066L42.5156 58.2822C43.2403 53.3487 43.6803 50.606 43.9795 45.752C43.6691 45.0355 43.4085 44.6573 43.1055 44.3857C42.7738 44.0886 42.2681 43.8101 41.2725 43.5H23.0713ZM58.7266 43.5C57.7309 43.8101 57.2252 44.0886 56.8936 44.3857C56.5905 44.6573 56.3299 45.0355 56.0195 45.752C56.3188 50.606 56.7587 53.3487 57.4834 58.2822L57.4863 58.3066L57.4893 58.332C57.5861 59.1921 57.799 59.5714 58.0977 59.8594C58.4539 60.2027 59.0707 60.5477 60.2725 61H76.8936C78.0756 60.8404 78.6916 60.5973 79.1328 60.248C79.5763 59.8968 80.0074 59.308 80.5293 58.1172C81.0129 53.2033 81.2601 50.3765 81.4805 45.8389C81.0241 45.0101 80.643 44.5717 80.1611 44.2715C79.5867 43.9136 78.6813 43.637 76.9277 43.5H58.7266Z"
            :fill "black"
            :fill-rule "evenodd"
            :clip-rule "evenodd"}]]))

(defn shades-003 [{:keys [lens-color]}]
  (asset-root
   [:<>
    [:path {:d "M20.2079 43.9987C25.2079 40.9988 35.2078 42.9987 41.7079 46.9987C48.208 50.9988 47.7082 57.9987 44.2079 61.9987C40.7075 65.9988 30.208 65.4988 22.7079 59.9987C15.2078 54.4987 15.2079 46.9987 20.2079 43.9987Z"
            :fill lens-color
            :fill-opacity 0.25}]
    [:path {:d "M80.7081 43.9989C75.7081 40.9989 65.7083 42.9989 59.2081 46.9989C52.708 50.9989 53.2078 57.9988 56.7081 61.9989C60.2085 65.9989 70.708 65.4989 78.2081 59.9989C85.7083 54.4988 85.7081 46.9988 80.7081 43.9989Z"
            :fill lens-color
            :fill-opacity 0.25}]
    [:path {:d "M50.707 47.999C57.7076 47.9989 59.7081 39.9992 77.207 40.999C84.7537 40.999 88.3781 46.5914 84.0712 51.6015C84.606 48.4478 83.3593 45.5903 80.707 43.999C75.7068 40.9994 65.7069 42.9991 59.207 46.999C56.6503 48.5725 55.1769 50.6104 54.5429 52.747C53.4805 51.825 51.9644 51.4941 50.707 51.499C49.4357 51.4941 47.566 51.8321 46.3808 52.7773C45.7518 50.6296 44.2768 48.5799 41.708 46.999C35.2079 42.9991 25.2079 40.9991 20.208 43.999C17.5554 45.5905 16.3095 48.4484 16.8447 51.6025C12.5366 46.5922 16.1609 40.9991 23.708 40.999C41.2069 39.9991 43.7066 47.9986 50.707 47.999Z"
            :fill "black"}]]))

(defn glasses-002 [{:keys [frame-color]}]
  (asset-root
   [:path {:d "M43 42.5C45.4853 42.5 47.5 44.5147 47.5 47V48.5H52.5V47C52.5 44.5147 54.5147 42.5 57 42.5H80C82.4853 42.5 84.5 44.5147 84.5 47V56C84.5 58.4853 82.4853 60.5 80 60.5H57C54.5147 60.5 52.5 58.4853 52.5 56V51.5H47.5V56C47.5 58.4853 45.4853 60.5 43 60.5H20C17.5147 60.5 15.5 58.4853 15.5 56V47C15.5 44.5147 17.5147 42.5 20 42.5H43ZM20 45.5C19.1716 45.5 18.5 46.1716 18.5 47V56C18.5 56.8284 19.1716 57.5 20 57.5H43C43.8284 57.5 44.5 56.8284 44.5 56V47C44.5 46.1716 43.8284 45.5 43 45.5H20ZM57 45.5C56.1716 45.5 55.5 46.1716 55.5 47V56C55.5 56.8284 56.1716 57.5 57 57.5H80C80.8284 57.5 81.5 56.8284 81.5 56V47C81.5 46.1716 80.8284 45.5 80 45.5H57Z"
           :fill frame-color
           :fill-rule "evenodd"
           :clip-rule "evenodd"}]))

(defn glasses-003 [{:keys [frame-color]}]
  (asset-root
   [:path {:d "M66.5 35C74.232 35 80.5 41.268 80.5 49C80.5 56.732 74.232 63 66.5 63C59.1043 63 53.0489 57.2652 52.5361 50H47.9639C47.4511 57.2652 41.3957 63 34 63C26.268 63 20 56.732 20 49C20 41.268 26.268 35 34 35C41.3957 35 47.4511 40.7348 47.9639 48H52.5361C53.0489 40.7348 59.1043 35 66.5 35ZM34 37C27.3726 37 22 42.3726 22 49C22 55.6274 27.3726 61 34 61C40.6274 61 46 55.6274 46 49C46 42.3726 40.6274 37 34 37ZM66.5 37C59.8726 37 54.5 42.3726 54.5 49C54.5 55.6274 59.8726 61 66.5 61C73.1274 61 78.5 55.6274 78.5 49C78.5 42.3726 73.1274 37 66.5 37Z"
           :fill frame-color
           :fill-rule "evenodd"
           :clip-rule "evenodd"}]))

(defn glasses-004 [{:keys [frame-color]}]
  (asset-root
   [:path {:d "M69.207 39C73.475 39 77.3811 40.2262 80.2461 42.2598C83.1088 44.2917 85 47.1909 85 50.5C85 53.8091 83.1088 56.7083 80.2461 58.7402C77.3811 60.7738 73.475 62 69.207 62C64.9391 62 61.033 60.7737 58.168 58.7402C55.5975 56.9157 53.8107 54.3919 53.4727 51.5H47.5273C47.1893 54.3919 45.4025 56.9157 42.832 58.7402C39.967 60.7737 36.0609 62 31.793 62C27.525 62 23.6189 60.7738 20.7539 58.7402C17.8912 56.7083 16 53.8091 16 50.5C16 47.1909 17.8912 44.2917 20.7539 42.2598C23.6189 40.2262 27.525 39 31.793 39C36.0609 39 39.967 40.2263 42.832 42.2598C45.4025 44.0843 47.1893 46.6081 47.5273 49.5H53.4727C53.8107 46.6081 55.5975 44.0843 58.168 42.2598C61.033 40.2263 64.9391 39 69.207 39ZM31.793 41C27.891 41 24.4001 42.124 21.9111 43.8906C19.4199 45.6589 18 48.0102 18 50.5C18 52.9898 19.4199 55.3411 21.9111 57.1094C24.4001 58.876 27.891 60 31.793 60C35.695 60 39.1858 58.8761 41.6748 57.1094C44.1661 55.3411 45.5859 52.9899 45.5859 50.5C45.5859 48.0101 44.1661 45.6589 41.6748 43.8906C39.1858 42.1239 35.695 41 31.793 41ZM69.207 41C65.305 41 61.8142 42.1239 59.3252 43.8906C56.8339 45.6589 55.4141 48.0101 55.4141 50.5C55.4141 52.9899 56.8339 55.3411 59.3252 57.1094C61.8142 58.8761 65.305 60 69.207 60C73.109 60 76.5999 58.876 79.0889 57.1094C81.5801 55.3411 83 52.9898 83 50.5C83 48.0102 81.5801 45.6589 79.0889 43.8906C76.5999 42.124 73.109 41 69.207 41Z"
           :fill frame-color
           :fill-rule "evenodd"
           :clip-rule "evenodd"}]))

(defn glasses-005 [{:keys [frame-color]}]
  (asset-root
   [:path {:d "M54.1699 44.8202C56.5875 39.8168 65.4422 35.4284 77.2002 36.9999C84.7286 38.0575 87.889 44.521 83.2002 52.9999C78.5112 61.479 64.1311 63.1155 57.4902 58.8466C53.884 56.5283 52.5052 54.0667 52.3828 51.4999H48.0215C47.8991 54.0667 46.5203 56.5283 42.9141 58.8466C36.2732 63.1155 21.8931 61.479 17.2041 52.9999C12.5153 44.521 15.6757 38.0575 23.2041 36.9999C34.9621 35.4284 43.8168 39.8168 46.2344 44.8202C46.835 46.0633 47.3419 47.2912 47.6631 48.4999H52.7412C53.0624 47.2912 53.5693 46.0633 54.1699 44.8202ZM43.7041 45.4999C41.7037 42 34.3494 39.3778 25.7041 39.9999C20.5964 41.0207 17.8143 45.2238 20.7041 51.9999C23.594 58.7761 36.2045 60.4999 41.2041 56.9999C46.2036 53.5 45.7044 48.9998 43.7041 45.4999ZM74.7002 39.9999C66.0549 39.3778 58.7006 42 56.7002 45.4999C54.6999 48.9998 54.2007 53.5 59.2002 56.9999C64.1998 60.4999 76.8103 58.7761 79.7002 51.9999C82.59 45.2238 79.8079 41.0207 74.7002 39.9999Z"
           :fill frame-color
           :fill-rule "evenodd"
           :clip-rule "evenodd"}]))

(defn glasses-renderer
  "Renderer used by :glasses feature registry."
  [shape]
  (fn [{:keys [color]}]
    (case shape
      :glasses_001
      (glasses-001 {:frame-color (get cfg/frame-colors (or color :charcoal))})

      :glasses_002
      (glasses-002 {:frame-color (get cfg/frame-colors (or color :charcoal))})

      :glasses_003
      (glasses-003 {:frame-color (get cfg/frame-colors (or color :charcoal))})

      :glasses_004
      (glasses-004 {:frame-color (get cfg/frame-colors (or color :charcoal))})

      :glasses_005
      (glasses-005 {:frame-color (get cfg/frame-colors (or color :charcoal))})

      :shades_001
      (shades-001 {:lens-color (get cfg/shades-colors (or color :charcoal))})

      :shades_002
      (shades-002 {:lens-color (get cfg/shades-colors (or color :charcoal))})

      :shades_003
      (shades-003 {:lens-color (get cfg/shades-colors (or color :charcoal))})

      nil)))

;; -------------------------
;; Feature registry
;; -------------------------

(def feature-registry
  {:head
   {:default head-default
    :shapes head-registry}

   :hair
   {:default :bald
    :shapes
    {:bald {:label "Bald" :render hair-bald :order 0}
     :one {:label "Hair 001" :render hair-001 :order 1}
     :two {:label "Hair 002" :render hair-002 :order 2}
     :three {:label "Hair 003" :render hair-003 :order 3}
     :four {:label "Hair 004" :render hair-004 :order 4}
     :five {:label "Hair 005" :render hair-005 :order 5}
     :six {:label "Hair 006" :render hair-006 :order 6}}}

   :birthmark
   {:default :none
    :shapes
    {:none {:label "None" :render birthmark-none :order 0}
     :one {:label "Birthmark 001" :render birthmark-001 :order 1}}}

   :eyes
   {:default :001
    :shapes
    {:001 {:label "001" :render eye-001 :order 1}
     :002 {:label "002" :render eye-002 :order 2}
     :003 {:label "003" :render eye-003 :order 3}
   
     :004 {:label "004" :render eye-004 :order 4}
     :005 {:label "005" :render eye-005 :order 5}
     :006 {:label "006" :render eye-006 :order 6}
   
     :007 {:label "007" :render eye-007 :order 7}
     :008 {:label "008" :render eye-008 :order 8}
     :009 {:label "009" :render eye-009 :order 9}
     :010 {:label "010" :render eye-010 :order 10}
     :011 {:label "011" :render eye-011 :order 11}
     :012 {:label "012" :render eye-012 :order 12}
     :013 {:label "013" :render eye-013 :order 13}
     :014 {:label "014" :render eye-014 :order 14}
     :015 {:label "015" :render eye-015 :order 15}}}

   :nose
   {:default :one
    :shapes
    {:none {:label "None" :render nose-none :order 0}
     :one {:label "One" :render nose-one :order 1}
     :two {:label "Two" :render nose-two :order 2}
     :three {:label "Three" :render nose-three :order 3}
     :four {:label "Four" :render nose-four :order 4}
     :five {:label "Five" :render nose-five :order 5}
     :six {:label "Six" :render nose-six :order 6}
     :seven {:label "Seven" :render nose-seven :order 7}
     :eight {:label "Eight" :render nose-eight :order 8}
     :nine {:label "Nine" :render nose-nine :order 9}
     :ten {:label "Ten" :render nose-ten :order 10}
     :eleven {:label "Eleven" :render nose-eleven :order 11}
     :twelve {:label "Twelve" :render nose-twelve :order 12}
     :thirteen {:label "Thirteen" :render nose-thirteen :order 13}}}

   :mouth
   {:default :one
    :shapes
    {:one {:label "001" :render mouth-001 :order 1}
     :two {:label "002" :render mouth-002 :order 2}
     :three {:label "003" :render mouth-003 :order 3}
     :four {:label "004" :render mouth-004 :order 4}
     :five {:label "005" :render mouth-005 :order 5}
     :six {:label "006" :render mouth-006 :order 6}
     :seven {:label "007" :render mouth-007 :order 7}
     :eight {:label "008" :render mouth-008 :order 8}
     :nine {:label "009" :render mouth-009 :order 9}
     :ten {:label "010" :render mouth-010 :order 10}
     :eleven {:label "011" :render mouth-011 :order 11}
     :twelve {:label "012" :render mouth-012 :order 12}
     :thirteen {:label "013" :render mouth-013 :order 13}
     :fourteen {:label "014" :render mouth-014 :order 14}
     :fifteen {:label "015" :render mouth-015 :order 15}
     :sixteen {:label "016" :render mouth-016 :order 16}
   
     :seventeen {:label "017" :render mouth-017 :order 17}
   
     :eighteen {:label "018" :render mouth-018 :order 18}
     :nineteen {:label "019" :render mouth-019 :order 19}
     :twenty {:label "020" :render mouth-020 :order 20}
     :twenty-one {:label "021" :render mouth-021 :order 21}}}

   :glasses
   {:default :none
    :shapes
    {:none {:label "None" :render (fn [_] nil) :order 0}
     ;; Glasses first (numerical)
     :glasses_001 {:label "Glasses 001" :render (glasses-renderer :glasses_001) :order 1}
     :glasses_002 {:label "Glasses 002" :render (glasses-renderer :glasses_002) :order 2}
     :glasses_003 {:label "Glasses 003" :render (glasses-renderer :glasses_003) :order 3}
     :glasses_004 {:label "Glasses 004" :render (glasses-renderer :glasses_004) :order 4}
     :glasses_005 {:label "Glasses 005" :render (glasses-renderer :glasses_005) :order 5}
     ;; Shades after glasses (numerical)
     :shades_001 {:label "Shades 001" :render (glasses-renderer :shades_001) :order 6}
     :shades_002 {:label "Shades 002" :render (glasses-renderer :shades_002) :order 7}
     :shades_003 {:label "Shades 003" :render (glasses-renderer :shades_003) :order 8}}}

   ;; Keep placeholders for non-migrated features so normalization and
   ;; renderer resolution can still be defensive.  
   
   :ears {:default :none :shapes {:none {:label "None" :render (fn [_] nil) :order 0}}}
   
   :brows
   {:default :none
    :shapes
    {:none {:label "None" :render brow-none :order 0}
     :001 {:label "001" :render brow-001 :order 1}
     :002 {:label "002" :render brow-002 :order 2}
     :003 {:label "003" :render brow-003 :order 3}
     :004 {:label "004" :render brow-004 :order 4}
     :005 {:label "005" :render brow-005 :order 5}
     :006 {:label "006" :render brow-006 :order 6}
     :007 {:label "007" :render brow-007 :order 7}
     :008 {:label "008" :render brow-008 :order 8}}}})

(defn sorted-shape-entries [feature]
  (->> (get-in feature-registry [feature :shapes])
       (sort-by (fn [[_ {:keys [order]}]] (or order 9999)))
       vec))

(defn resolve-renderer [feature shape]
  (or (get-in feature-registry [feature :shapes shape :render])
      (get-in feature-registry [feature :shapes (get-in feature-registry [feature :default]) :render])
      (fn [_] nil)))

;; -------------------------
;; Spec normalization
;; -------------------------

(defn valid-shape?
  [feature shape]
  (contains? (get-in feature-registry [feature :shapes]) shape))

(defn ->kw [x]
  (cond
    (keyword? x) x
    (string? x)  (keyword x)
    :else        nil))

(defn normalize-feature
  "Fix JSON string -> keyword mismatch, enforce valid shape values, apply defaults defensively."
  [spec feature]
  (let [default-shape (get-in feature-registry [feature :default])]
    (update-in spec [:parts feature]
               (fn [part]
                 (let [shape (->kw (:shape part))]
                   (if (valid-shape? feature shape)
                     (assoc (or part {}) :shape shape)
                     (assoc (or part {}) :shape default-shape)))))))

(defn ->color-kw [v]
  (cond
    (keyword? v) v
    (string? v)  (keyword v)
    :else        nil))

(defn normalize-glasses [spec]
  (let [shape-default (get-in feature-registry [:glasses :default])]
    (-> spec
        (update-in [:parts :other] #(or % {}))
        (update-in [:parts :other :category] #(or (->kw %) :glasses))
        (update-in [:parts :other :glasses]
                   (fn [g]
                     (let [g (or g {})
                           shape (->kw (:shape g))
                           shape (if (valid-shape? :glasses shape) shape shape-default)
                           color (->color-kw (or (:color g) (:frame g) (:lens g)))]
                       (assoc g
                              :shape shape
                              :color (if (contains? cfg/frame-colors color) color :blue)
                              :scale (or (:scale g) 1.0)
                              :y-offset (or (:y-offset g) 0))))))))

(defn normalize-birthmark [spec]
  (let [shape-default (get-in feature-registry [:birthmark :default])]
    (-> spec
        (update-in [:parts :other] #(or % {}))
        (update-in [:parts :other :birthmark]
                   (fn [b]
                     (let [b (or b {})
                           shape (->kw (:shape b))
                           shape (if (valid-shape? :birthmark shape) shape shape-default)]
                       (assoc b
                              :shape shape
                              :size (or (:size b) 1.0)
                              :x-offset (or (:x-offset b) 0)
                              :y-offset (or (:y-offset b) 0))))))))

(defn normalize-spec [spec]
  (-> spec
      (normalize-feature :eyes)
      (normalize-feature :head)
      (normalize-feature :nose)
      (normalize-feature :ears)
      (normalize-feature :mouth)
      (normalize-feature :hair)
      (normalize-feature :brows)
      (normalize-glasses)
      (normalize-birthmark)
      (update-in [:parts :head :skin] ->color-kw)
      (update-in [:parts :eyes :iris] ->color-kw)
      (update-in [:parts :hair :color] ->color-kw)
      (update-in [:parts :mouth :color] ->color-kw)
      (update-in [:parts :brows :color] ->color-kw)

      ;; ensure defaults  (treat nil as missing) 
      (update-in [:parts :nose :stroke] #(or % "black"))
      (update-in [:parts :nose :size] #(or % 1.0))
      (update-in [:parts :nose :y-offset] #(or % 0))
      (update-in [:parts :mouth :size] #(or % 1.0))
      (update-in [:parts :mouth :y-offset] #(or % 0))

      (update-in [:parts :head :skin]
                 #(if (contains? cfg/skin-tones %)
                    %
                    :light-cream))
      (update-in [:parts :hair :color]
                 #(if (contains? cfg/hair-colors %)
                    %
                    :jet-black))
      (update-in [:parts :brows]
                 #(or % {:shape :none :color :jet-black :size 1.0 :x-offset 0 :y-offset 0 :rotation 0}))
      (update-in [:parts :brows :color]
                 #(if (contains? cfg/hair-colors %)
                    %
                    :jet-black))

      (update-in [:parts :eyes :iris]
                 #(if (contains? cfg/iris-colors %)
                    %
                    :black))
      (update-in [:parts :mouth :color]
                 #(if (contains? cfg/lip-colors %)
                    %
                    :black))
      (update-in [:parts :eyes :spacing] #(or % 0.54))
      (update-in [:parts :eyes :size] #(or % 1.1))
      (update-in [:parts :eyes :y-offset] #(or % 0))

      (update-in [:parts :eyes :rotation] #(or % 0))
      (update-in [:parts :other :glasses :scale] #(or % 1.0))
      (update-in [:parts :other :glasses :y-offset] #(or % 0))
      (update-in [:parts :other :birthmark :size] #(or % 1.0))
      (update-in [:parts :other :birthmark :x-offset] #(or % 0))
      (update-in [:parts :other :birthmark :y-offset] #(or % 0))))

(defn clamp
  [mn mx v]
  (-> v (max mn) (min mx)))

(defn clamp-cfg
  [k value]
  (let [{:keys [min max]} (get cfg/constants k)]
    (if (and (number? min) (number? max) (number? value))
      (clamp min max value)
      value)))

;; -------------------------
;; Avatar render pipeline
;; -------------------------

(defn head-transform []
  (str "translate(" (:head/cx cfg/geometry) " "
       (+ (:head/cy cfg/geometry) (:head/y-offset cfg/geometry)) ") "
       "scale(" (:head/scale cfg/geometry) ")"))

(defn head-svg [{:keys [shape skin]}]
  (let [renderer (resolve-renderer :head shape)
        skin-key (if (contains? cfg/skin-tones skin) skin :light-cream)]
    [:g {:transform (head-transform)}
     [renderer {:skin skin-key}]]))

(defn hair-svg [{:keys [shape color]}]
  (let [renderer (resolve-renderer :hair shape)
        layers   (renderer {:color (get cfg/hair-colors color (get cfg/hair-colors :jet-black))})]
    {:back
     (when (:back layers)
       [:g {:transform (head-transform)}
        (:back layers)])

     :front
     (when (:front layers)
       [:g {:transform (head-transform)}
        (:front layers)])

     :front2
     (when (:front2 layers)
       [:g {:transform (head-transform)}
        (:front2 layers)])}))

(defn ears-svg [_ears _head] nil)
(defn mouth-svg [{:keys [shape color size y-offset]}]
  (let [renderer (resolve-renderer :mouth shape)
        base-scale (:mouth/scale cfg/geometry)
        user-scale (clamp-cfg :mouth/size (or size 1.0))
        sc (* base-scale user-scale)
        y (+ (:mouth/base-y cfg/geometry)
             (clamp-cfg :mouth/y-offset (or y-offset 0)))
        cx (:head/cx cfg/geometry)]
    [:g {:transform
         (str "translate(" cx " " y ") "
              "scale(" sc ")")}
     (renderer {:lip-color (get cfg/lip-colors color (get cfg/lip-colors :black))})]))
(defn nose-svg [{:keys [shape stroke size y-offset]} _head]
  (when (not= shape :none)
    (let [renderer (resolve-renderer :nose shape)
          base-scale (:nose/scale cfg/geometry)
          user-scale (clamp-cfg :nose/size (or size 1.0))
          final-scale (* base-scale user-scale)
          base-y (:nose/base-y cfg/geometry)
          user-y (clamp-cfg :nose/y-offset (or y-offset 0))
          final-y (+ base-y user-y)
          cx (:head/cx cfg/geometry)]
      [:g {:transform
           (str "translate(" cx " " final-y ") "
                "scale(" final-scale ")")}
       (renderer {:stroke (or stroke "black")
                  :fill "black"})])))
(defn eyes-svg [{:keys [spacing size y-offset iris shape rotation]}]
  (let [s (clamp-cfg :eyes/spacing (or spacing 0.54))
        sc (clamp-cfg :eyes/size (or size 1.1))
        y (clamp-cfg :eyes/y-offset (or y-offset 0))
        rot (clamp-cfg :eyes/rotation (or rotation 0))
        dx (* (:eyes/dx-scale cfg/geometry) s)
        cy (+ (:eyes/base-y cfg/geometry) y)
        eye-fn (resolve-renderer :eyes shape)
        head-cx (:head/cx cfg/geometry)
        iris-hex (get cfg/iris-colors iris (get cfg/iris-colors :black))]
    [:g
     [:g {:transform
          (str "translate(" (- head-cx dx) " " cy ") "
               "rotate(" (* -1 rot) ") "
               "scale(" sc ") "
               "scale(-1 1)")}
      (eye-fn {:iris iris-hex :mirrored? true})]
     [:g {:transform
          (str "translate(" (+ head-cx dx) " " cy ") "
               "rotate(" rot ") "
               "scale(" sc ")")}
      (eye-fn {:iris iris-hex :mirrored? false})]]))
(defn brows-svg
  [{:keys [shape color size x-offset y-offset rotation]}]
  (when (not= shape :none)
    (let [sc (clamp-cfg :brows/size (or size 1.0))
          xoff (clamp-cfg :brows/x-offset (or x-offset 0))
          yoff (clamp-cfg :brows/y-offset (or y-offset 0))
          rot (clamp-cfg :brows/rotation (or rotation 0))
          head-cx (:head/cx cfg/geometry)
          cy (+ (:brows/base-y cfg/geometry) yoff)
          dx (+ (:brows/base-dx cfg/geometry) xoff)
          brow-fn (resolve-renderer :brows shape)
          brow-color (get cfg/hair-colors color (get cfg/hair-colors :jet-black))]
      [:g
       [:g {:transform
            (str "translate(" (- head-cx dx) " " cy ") "
                 "rotate(" (* -1 rot) ") "
                 "scale(" sc ") "
                 "scale(-1 1)")}
        (brow-fn {:color brow-color})]
       [:g {:transform
            (str "translate(" (+ head-cx dx) " " cy ") "
                 "rotate(" rot ") "
                 "scale(" sc ")")}
        (brow-fn {:color brow-color})]])))
(defn glasses-svg [{:keys [shape color scale y-offset]}]
  (when (and shape (not= shape :none))
    (let [renderer (resolve-renderer :glasses shape)
          user-scale (clamp-cfg :glasses/scale (or scale 1.0))
          yoff (clamp-cfg :glasses/y-offset (or y-offset 0))
          base-scale (:glasses/scale cfg/geometry)
          final-scale (* base-scale user-scale)
          cx (:head/cx cfg/geometry)
          y (+ (:glasses/base-y cfg/geometry) yoff)]
      [:g {:transform (str "translate(" cx " " y ") "
                           "scale(" final-scale ")")}
       (renderer {:color color})])))

(defn birthmark-svg [{:keys [shape size x-offset y-offset]}]
  (when-let [node (birthmark-node {:shape shape
                                   :size size
                                   :x-offset x-offset
                                   :y-offset y-offset
                                   :scale-factor (:birthmark/base-scale cfg/geometry)})]
    [:g {:transform (head-transform)}
     node]))

(defn avatar->hiccup
  "Layering: back hair -> ears -> head -> birthmark -> mouth -> nose -> eyes -> brows -> front hair -> glasses."
  ([spec]
   (avatar->hiccup spec {}))
  ([spec svg-attrs]
   (let [spec* (normalize-spec spec)
         {:keys [head eyes ears mouth nose hair brows]} (:parts spec*)
         {:keys [back front front2]} (hair-svg hair)
         base-svg-attrs {:xmlns "http://www.w3.org/2000/svg"
                         :viewBox "0 0 512 512"}]
     [:svg (merge base-svg-attrs svg-attrs)
     back
     (ears-svg ears head)
     (head-svg head)
      (birthmark-svg (get-in spec* [:parts :other :birthmark]))
      (mouth-svg mouth)
      (nose-svg nose head)
      (eyes-svg eyes)
      (brows-svg brows)
      front
      front2
      (glasses-svg (get-in spec* [:parts :other :glasses]))])))
