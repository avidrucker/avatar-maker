(ns avatar.render
  (:require [avatar.config :as cfg]))

(defn with-keys
  "Given a seq of hiccup nodes, attach stable React keys.
   If a node already has :key in attrs or ^{:key ...} metadata, leave it alone."
  [nodes]
  (->> nodes
       (map-indexed
        (fn [i node]
          (cond
            (nil? node) nil
            (-> node meta :key) node
            (and (vector? node)
                 (map? (nth node 1 nil))
                 (contains? (nth node 1) :key))
            node
            :else
            (with-meta node {:key (str "k" i)}))))
       (remove nil?)))

(defn head-root
  "Wrap geometry in a group centered on a normalized 100x100 asset space."
  [& children]
  (into
   [:g {:transform "translate(-50 -50)"}]
   (with-keys children)))

(defn hair-root
  "Center a normalized 100x100 hair asset at (0,0)."
  [& children]
  (into
   [:g {:transform "translate(-50 -50)"}]
   (with-keys children)))

;; -------------------------
;; Head renderers
;; -------------------------

(defn head-average [{:keys [skin]}]
  (head-root
   [:path {:d "M73 46C71 70.3594 60.7025 80 50 80C39.2975 80 29 70.3594 27 46C27 31.6406 37.2975 20 50 20C62.7025 20 73 31.6406 73 46Z"
           :fill skin}]))

(defn head-blocky [{:keys [skin]}]
  (head-root
   [:path {:d "M73 46C67 68.3594 80.7025 80 50 80C19.2975 80 33 68.3594 27 46C27 31.6406 37.2975 20 50 20C62.7025 20 73 31.6406 73 46Z"
           :fill skin}]))

(defn head-oval [{:keys [skin]}]
  (head-root
   [:path {:d "M73 46C73 68.3594 64.7025 80 50 80C35.2975 80 27 68.3594 27 46C27 31.6406 37.2975 20 50 20C62.7025 20 73 31.6406 73 46Z"
           :fill skin}]))

(defn head-pointy [{:keys [skin]}]
  (head-root
   [:path {:d "M73 46C73 60.3594 56.7025 80 50 80C43.2975 80 27 60.3594 27 46C27 31.6406 37.2975 20 50 20C62.7025 20 73 31.6406 73 46Z"
           :fill skin}]))

(defn head-egg [{:keys [skin]}]
  (head-root
   [:path {:d "M73 46C73 60.3594 62.7025 80 50 80C37.2975 80 27 60.3594 27 46C27 31.6406 37.2975 20 50 20C62.7025 20 73 31.6406 73 46Z"
           :fill skin}]))

(def head-registry
  {:average {:label "Average" :render head-average :order 0}
   :blocky  {:label "Blocky"  :render head-blocky  :order 1}
   :oval    {:label "Oval"    :render head-oval    :order 2}
   :pointy  {:label "Pointy"  :render head-pointy  :order 3}
   :egg     {:label "Egg"     :render head-egg     :order 4}})

(def head-order
  "Controls display order in the UI."
  [:average :blocky :oval :pointy :egg])

;; -------------------------
;; Hair renderers
;; -------------------------

(defn make-hair
  [{:keys [front front2 back]}]
  (fn hair-renderer [{:keys [color]}]
    {:front
     (when front
       (hair-root
        [:path {:d front :fill color}]))

     :front2
     (when front2
       (hair-root
        [:path {:d front2 :fill color}]))

     :back
     (when back
       (hair-root
        [:path {:d back :fill color}]))}))

(def hair-001
  (make-hair
   {:front
    "M30.5003 44.5L28.0003 56C28.0003 56 21.4767 48 28.0003 31C34.5031 14.0542 65.5072 13.6002 72.0003 31C77.5 49 72.0003 56 72.0003 56L69.0003 44.5L66.5003 48L62.5003 39.5L58.5003 45L53.5003 36.5L49.5003 44.5L45.5003 36.5L41.0003 44.5L37 39.5L33.5003 48L30.5003 44.5Z"}))

(def hair-002
  (make-hair
   {:back
    "M31.0001 76.5L30.0001 79.5C11.0001 60 24.4999 33 31.0001 27 C40.5001 15 59.5 17 69.0001 27 C82.7775 46.8304 83.5 63 69.0001 79.5 L67.5001 76.5L65.5001 79.5 C63.7238 74.9543 62.5313 72.5368 58.5001 69.5 H40.5001 C36.7742 73.0768 35.4795 75.3017 34.0001 79.5 L31.0001 76.5Z"

    :front
    "M58 20.5 C53.5 34.5 42.0001 50.5 21.5002 63 C20.0001 55 20.5 48 24.0001 38 C34.5 17.5 47.5 17 58 20.5Z"

    :front2
    "M52 19 C70 19.5 82.5 42.5 78.5 64 L52 19Z"}))

(def hair-bald
  (make-hair {}))

;; -------------------------
;; Eye renderers
;; -------------------------

(defn eye-root
  "Wrap a normalized 100x100 eye SVG so it is centered at (0,0)."
  [& children]
  (into
   [:g {:transform "translate(-50 -50)"}]
   (with-keys children)))

(defn clip-eyeball
  [{:keys [clip-id clip-path]} & children]
  [:<>
   [:defs
    [:clipPath {:id clip-id}
     [:path {:d clip-path}]]]
   [:g {:clip-path (str "url(#" clip-id ")")}
    (into [:<>] (with-keys children))]])

(defn make-eye
  [{:keys [white eyeball outline lids layers]}]
  (fn eye-renderer [{:keys [iris]}]
    (let [clip-id (str "eye-clip-" (random-uuid))
          path (:path white)]
      (eye-root
       (when white
         [:path {:d path :fill "white"}])
       (when eyeball
         (if white
           (clip-eyeball
            {:clip-id clip-id :clip-path path}
            [:circle {:cx (:cx eyeball) :cy (:cy eyeball) :r (:r eyeball)
                      :fill (or iris "#3B5BA5")}]
            [:circle {:cx (:cx eyeball) :cy (:cy eyeball) :r (:pupil-r eyeball)
                      :fill "black"}])
           [:<>
            [:circle {:cx (:cx eyeball) :cy (:cy eyeball) :r (:r eyeball)
                      :fill (or iris "#3B5BA5")}]
            [:circle {:cx (:cx eyeball) :cy (:cy eyeball) :r (:pupil-r eyeball)
                      :fill "black"}]]))
       (when outline
         [:path {:d path
                 :fill "none"
                 :stroke (:stroke outline)
                 :stroke-width (:stroke-width outline)}])
       (for [{:keys [path fill]} layers]
         ^{:key path}
         [:path {:d path :fill (or fill "black")}])
       (for [{:keys [path fill]} lids]
         ^{:key path}
         [:path {:d path :fill (or fill "black")}])))))

(def eye-001
  (make-eye
   {:eyeball {:cx 43.6 :cy 53.6 :r 17.6 :pupil-r 11.2}
    :layers [{:path "M4.27246 50.6373C15.258 35.6327 30.2421 28.9491 44.8389 29.5025C59.358 30.053 73.1435 37.7541 81.8281 50.7808L75.1719 55.2193C67.8565 44.2463 56.3918 37.9472 44.5361 37.4976C32.758 37.051 20.242 42.3676 10.7275 55.3628L4.27246 50.6373Z"
              :fill "black"}]}))

(def eye-002
  (make-eye
   {:eyeball {:cx 41.5 :cy 57.5 :r 22.5 :pupil-r 15}
    :layers [{:path "M41.8291 24.1266C54.4092 23.7851 66.5306 30.7022 74.3799 44.4206L94.9805 38.151L97.0195 44.8483L77.501 50.7878C78.3654 52.8608 79.1472 55.0513 79.834 57.359L76 58.5006L72.166 59.6413C66.2953 39.9158 53.6101 31.8097 42.0459 32.1237C30.3578 32.4411 17.9844 41.3813 12.8496 59.5866L5.15039 57.4147C11.0156 36.62 25.8923 24.5593 41.8291 24.1266Z"
              :fill "black"}]}))

(def eye-003
  (make-eye
   {:eyeball {:cx 38.6 :cy 53.6 :r 17.6 :pupil-r 11.2}
    :layers [{:path "M50 20C66.929 21.1543 75.3109 27.2724 78.4619 37.125L85.6592 34.1377L88.0469 38.6982L79.8232 44.2227C80.0157 46.4449 80.0381 48.7974 79.916 51.2715L91.8135 50.4766L91.7695 55.999L79.1963 58.6426C79.1336 59.0919 79.0693 59.5445 79 60H70.5C67.851 45.39 63.05 38 50 36C25.5 36 22.5 45 12.5 66L5 65C10.5 39 23 21 50 20Z"
              :fill "black"}]}))

(defn eye-004 [{:keys [iris]}]
  (let [clip-id (str "eye004-" (random-uuid))]
    (eye-root
     [:circle {:cx 43 :cy 55 :r 26 :fill "white"}]
     [:defs
      [:clipPath {:id clip-id}
       [:circle {:cx 43 :cy 55 :r 26}]]]
     [:g {:clip-path (str "url(#" clip-id ")")}
      [:circle {:cx 37.6 :cy 46.6 :r 21.6 :fill (or iris "#3C06FF")}]
      [:circle {:cx 37.6 :cy 46.6 :r 13.7455 :fill "black"}]]
     [:path
      {:d "M43 21C61.7777 21 77 36.2223 77 55C77 66.2666 71.5181 76.2508 63.0781 82.4375L58.2773 76.0371C64.7747 71.3105 69 63.6496 69 55C69 40.6406 57.3594 29 43 29C28.6406 29 17 40.6406 17 55H9C9 36.2223 24.2223 21 43 21Z"
       :fill "black"}])))

(defn eye-005 [_]
  (eye-root
   [:path
    {:d "M10.5003 47.5C11.5004 42 25.0004 35.0002 39.0003 36.5C52.8733 37.9864 61.3669 42.466 66.8119 53.4698L85.5003 48L87.0003 53L69.8128 61.1407C70.0494 61.9049 70.279 62.691 70.5003 63.5L64.0003 64.5C55.0003 51.5 44.4389 50.2212 20.0003 55.5C12.3202 56.2201 9.50039 53.0001 10.5003 47.5Z"
     :fill "black"}]))

(defn eye-006 [{:keys [iris]}]
  (let [clip-id (str "eye006-" (random-uuid))
        white-path "M79 58.9997C76 76.9999 21.5 77.9999 13 50.9997C9.7532 41.4998 14.5579 38.7678 20 34.9997C39.1586 32.8073 50.3195 34.5067 71 41.4997C77.6495 45.4972 82 46.9999 79 58.9997Z"]
    (eye-root
     [:path {:d white-path :fill "white"}]
     [:defs
      [:clipPath {:id clip-id}
       [:path {:d white-path}]]]
     [:g {:clip-path (str "url(#" clip-id ")")}
      [:circle {:cx 41.6 :cy 49.6 :r 19.4 :fill (or iris "#3C06FF")}]
      [:circle {:cx 41.6 :cy 49.6 :r 12.3455 :fill "black"}]]
     [:path
      {:d "M44.9592 33.0022C57.6309 33.0236 68.0118 33.9482 75.0519 38.2342C78.8 40.5161 81.5546 43.7062 83.2216 47.9385C84.8488 52.0696 85.3643 56.9969 85.0509 62.7223L77.0635 62.2852C77.3414 57.2089 76.8331 53.5462 75.7791 50.8702C74.765 48.2955 73.1807 46.4602 70.8918 45.0668C65.9425 42.0539 57.6196 40.9999 44.5003 40.9999C44.1934 40.9999 43.8871 40.9646 43.5884 40.8947C37.7965 39.5391 33.1439 38.7381 29.3916 38.5507C25.6268 38.3627 23.0892 38.8125 21.3211 39.6669C18.19 41.1802 15.8476 44.8572 15.0447 54.8248L7.07005 54.1817C7.90474 43.8199 10.5341 35.9953 17.84 32.4644C21.2904 30.7968 25.3378 30.3386 29.7906 30.561C34.1427 30.7783 39.1901 31.6664 44.9592 33.0022Z"
       :fill "black"}])))

(defn eye-007 [{:keys [iris mirrored?]}]
  (eye-root
   [:circle {:cx 43.6 :cy 55.6 :r 30.4 :fill (or iris "#3C06FF")}]
   [:circle {:cx 43.6 :cy 55.6 :r 19.3455 :fill "black"}]
   [:g {:transform
        (when mirrored?
          "translate(43.6 0) scale(-1 1) translate(-43.6 0)")}
    [:path {:d "M52.5 34L56.4775 42.5225L65 46.5L56.4775 50.4775L52.5 59L48.5225 50.4775L40 46.5L48.5225 42.5225L52.5 34Z"
            :fill "white"}]
    [:path {:d "M33.5 56L36.8411 63.1589L44 66.5L36.8411 69.8411L33.5 77L30.1589 69.8411L23 66.5L30.1589 63.1589L33.5 56Z"
            :fill "white"}]]
   [:path {:d "M82 21L72.5059 31.7324C73.3641 32.7785 74.1655 33.8726 74.9082 35.0088L89.4004 29.8457L91.1562 34.8623L78.2305 41.3398C78.9241 43.0395 79.4968 44.8008 79.9375 46.6143L93.999 46.6104L93.9727 51.9248L80.9482 53.5293C80.982 54.1819 81 54.8389 81 55.5C81 55.6669 80.9953 55.8336 80.9932 56H73.9951C73.9968 55.8668 74 55.7332 74 55.5996C73.9998 38.8103 60.389 25.2002 43.5996 25.2002C26.8105 25.2004 13.2004 38.8104 13.2002 55.5996C13.2002 55.7332 13.2034 55.8668 13.2051 56H6.00684C6.00466 55.8336 6 55.6669 6 55.5C6 34.7893 22.7893 18 43.5 18C52.6414 18 61.0175 21.2727 67.5244 26.708L78.5 17L82 21Z"
           :fill "black"}]))

(defn eye-008 [_]
  (eye-root
   [:path {:d "M62.4997 58.4996L64.4997 52.9996C48.4997 48.5 23.9998 47.5 15.4997 50.4996C6.99997 54 12.4996 59.9996 14.9997 59.9996C26.5 60 40 55 62.4997 58.4996Z"
           :fill "black"}]
   [:path {:d "M93.0693 51.001L92.9307 55.999L74.9307 55.499L75.0693 50.501L93.0693 51.001Z"
           :fill "black"}]
   [:path {:d "M87.002 72.71L84.998 77.29L68.998 70.29L71.002 65.71L87.002 72.71Z"
           :fill "black"}]))

(defn eye-009 [_]
  (eye-root
   [:path {:d "M63.5977 29.0049L31.835 48H67V55H32.2725L62.7402 72.4639L59.2588 78.5361L18 55V48L60.0039 22.9971L63.5977 29.0049Z"
           :fill "black"}]))

(defn eye-010 [{:keys [iris]}]
  (let [clip-id (str "eye010-" (random-uuid))
        white-path "M34.998 40.958C45.6789 37.0991 58.413 37.7819 73.1064 42.6796L76.75 43.8945L75.2031 47.4091C69.3171 60.7865 60.1631 68.4349 48.9561 71.6171C37.9468 74.7432 25.3469 73.4513 12.5566 69.8701L8.50977 68.7373L10.3555 64.9628C16.1454 53.1197 24.2475 44.8421 34.998 40.958Z"]
    (eye-root
     [:path {:d white-path :fill "white"}]
     [:defs
      [:clipPath {:id clip-id}
       [:path {:d white-path}]]]
     [:g {:clip-path (str "url(#" clip-id ")")}
      [:circle {:cx 38 :cy 50 :r 18 :fill (or iris "#3C06FF")}]
      [:circle {:cx 38 :cy 50 :r 11.6471 :fill "black"}]]
     [:path {:d "M99 30L82 41.5C70.5 81 34 85 2 70C13 35.5 50 17 79 35.5L96.5 26L99 30ZM72 46C43.5 36.5 24.5 43.9999 13.5 66.5C38.5 73.5 61 71 72 46Z"
             :fill "black"
             :fill-rule "evenodd"
             :clip-rule "evenodd"}])))

(defn eye-011 [{:keys [iris]}]
  (eye-root
   [:circle {:cx 38 :cy 50 :r 18 :fill (or iris "#3C06FF")}]
   [:circle {:cx 38 :cy 50 :r 11.6471 :fill "black"}]))

(defn eye-012 [{:keys [iris]}]
  (let [clip-id (str "eye012-" (random-uuid))]
    (eye-root
     [:circle {:cx 50.5 :cy 51.5 :r 30 :fill "white"}]
     [:defs
      [:clipPath {:id clip-id}
       [:circle {:cx 50.5 :cy 51.5 :r 30}]]]
     [:g {:clip-path (str "url(#" clip-id ")")}
      [:circle {:cx 50.5 :cy 51.5 :r 17 :fill (or iris "#3C06FF")}]
      [:circle {:cx 50.5 :cy 51.5 :r 11 :fill "black"}]]
     [:path {:d "M75.5 51.2518C75.5 36.8243 64.6355 24.375 50 24.375C35.3645 24.375 24.5 36.8243 24.5 51.2518C24.5 65.6792 35.9167 77.375 50 77.375C64.0833 77.375 75.5 65.6792 75.5 51.2518ZM83.5 51C83.5 69.5015 68.5015 84.5 50 84.5C31.4985 84.5 16.5 69.5015 16.5 51C16.5 32.4985 31.4985 17.5 50 17.5C68.5015 17.5 83.5 32.4985 83.5 51Z"
             :fill "black"}])))

(defn eye-013 [{:keys [iris]}]
  (let [clip-id (str "eye013-" (random-uuid))
        white-path "M16 41H84C84 86.3333 16 86.3333 16 41Z"]
    (eye-root
     [:path {:d white-path :fill "white"}]
     [:defs
      [:clipPath {:id clip-id}
       [:path {:d white-path}]]]
     [:g {:clip-path (str "url(#" clip-id ")")}
      [:circle {:cx 49.75 :cy 39.4775 :r 23.5 :fill (or iris "#3C06FF")}]
      [:ellipse {:cx 50.25 :cy 39.4775 :rx 15 :ry 15.5 :fill "black"}]]
     [:path {:d "M87.5 37.5V41C87.5 53.2831 82.859 62.7529 75.7002 69.1162C68.6059 75.4222 59.2457 78.5 50 78.5C40.7543 78.5 31.3941 75.4222 24.2998 69.1162C17.141 62.7529 12.5 53.2831 12.5 41V37.5H87.5ZM19.6543 44.5C20.4207 53.0966 25.0079 59.4906 29.9502 63.8838C35.6058 68.911 42.2457 71 50 71C57.7542 71 64.3942 68.911 70.0498 63.8838C74.9921 59.4906 79.5793 53.0966 80.3457 44.5H19.6543Z"
             :fill "black"}])))

(defn eye-014 [{:keys [iris]}]
  (let [clip-id (str "eye014-" (random-uuid))
        white-path "M42.7412 35.6751C57.2775 30.4836 71.8013 35.4767 84.2666 43.3265C79.0439 55.5211 71.0228 66.0412 57.6689 69.7054C43.7774 73.5171 29.5529 69.3509 16.6211 64.18C21.5408 51.604 29.5201 40.3969 42.7412 35.6751Z"]
    (eye-root
     [:path {:d white-path :fill "white"}]
     [:defs
      [:clipPath {:id clip-id}
       [:path {:d white-path}]]]
     [:g {:clip-path (str "url(#" clip-id ")")}
      [:circle {:cx 44 :cy 53.5 :r 19.5 :fill (or iris "#3C06FF")}]
      [:circle {:cx 44 :cy 53.5 :r 12.5 :fill "black"}]]
     [:path {:d "M41.4502 31.3279C58.776 25.1525 77 30.4999 89.7139 42.3201C85 58.9998 74.0481 70.609 57.6406 74.7644C41.5048 78.851 23 73.4998 11.2744 65.7097C15.5 49.4999 25.7694 36.9171 41.4502 31.3279ZM80.5 44.4998C53.5001 27.4999 29.5001 39.4999 20.5 62.4998C48 73.4998 70 68.9998 80.5 44.4998Z"
             :fill "black"
             :fill-rule "evenodd"
             :clip-rule "evenodd"}])))

(defn eye-015 [_]
  (eye-root
   [:path {:d "M18 41H76V50H18V41Z"
           :fill "black"}]))

;; -------------------------
;; Brow renderers
;; -------------------------

(defn brow-root
  "Center a normalized 100x100 brow asset at (0,0)."
  [& children]
  (into
   [:g {:transform "translate(-50 -50)"}]
   (with-keys children)))

(defn make-brow
  "Create a brow renderer from one normalized SVG element."
  [element]
  (fn brow-renderer [{:keys [color]}]
    (brow-root
     (let [[tag attrs] element]
       [tag (assoc attrs :fill (or color "black"))]))))

(defn brow-none [_] nil)

(def brow-001
  (make-brow
   [:path {:d "M62 27.5L6.5 56.5V66.5L80.5 45L62 27.5Z"}]))

(def brow-002
  (make-brow
   [:path {:d "M8.50037 56.5C42.0398 28.635 57.5429 28.4721 81.5004 45.5C82.5 48.5 80.5 50 78.0004 49C59.83 38.4599 47.5507 36.6841 12.5004 59.5C9.50032 60.5 8.00003 59.5 8.50037 56.5Z"}]))

(def brow-003
  (make-brow
   [:path {:d "M55.5 32.5L5.5 48L9 66C57 52 58 51.5 82 57.5L55.5 32.5Z"}]))

(def brow-004
  (make-brow
   [:path {:d "M11.0914 54.0113C43.5529 29.3355 58.5578 29.1912 81.7453 44.2703C82.7128 46.9269 80.777 48.2552 78.3578 47.3697C57.0956 37.2186 48.7578 42.1117 21.5 62.5C13.6126 69.0701 5.13936 62.903 11.0914 54.0113Z"}]))

(def brow-005
  (make-brow
   [:path {:d "M79 43C49 41.6036 39.9558 45.8628 29 64.0001C22 71.5 9.5 68 9.5 55.0001C27 27 55.5 24.9999 79 43Z"}]))

(def brow-006
  (make-brow
   [:rect {:x 11 :y 44 :width 63 :height 17}]))

(def brow-007
  (make-brow
   [:path {:d "M8 43.4999C34.6082 43.1703 46.492 43.3306 55.5 44.9999C64.8392 48.4078 69.6547 51.8843 78 58.9999L73.5 66.9999C65.5721 62.596 61.275 60.3375 55.5 58.9999C37.5 57.4999 26.7077 61.4164 8 59.9999V43.4999Z"}]))

(def brow-008
  (make-brow
   [:path {:d "M44 44.4999C57.5 35 73.5 39.5 83 51.4999C68.388 46.1004 60.2547 43.7399 47 53.4999C26 65.5 11 63 9 57.9999C10.5 47.5 23 57.9999 44 44.4999Z"}]))

;; -------------------------
;; Nose renderers
;; -------------------------

(defn nose-root
  "Center a normalized 100x100 nose asset at (0,0)."
  [& children]
  (into
   [:g {:transform "translate(-50 -50)"}]
   (with-keys children)))

(defn make-nose
  [{:keys [path]}]
  (fn nose-renderer [{:keys [stroke fill]}]
    (nose-root
     [:path {:d path
             :fill (or fill "none")
             :stroke (or stroke "black")
             :stroke-width (:nose/stroke-width cfg/geometry)
             :vector-effect "non-scaling-stroke"}])))

(defn nose-none [_]
  nil)

(def nose-one
  (make-nose
   {:path "M52 32C52 45 42 51 42 62C42 73 56 73 56 73"}))

(def nose-two
  (make-nose
   {:path "M26 52C40 69 59 69 74 52"}))

(def nose-three
  (make-nose
   {:path "M25 57C41 87 59 87 75 57"}))

(def nose-four
  (make-nose
   {:path "M40.0001 22C40.6375 43.1992 39.1448 51.8232 33.0001 61C32.5757 69.3167 35.7176 72.7345 49.0001 76C67.5508 70.562 68.4456 64.891 60.0001 52"}))

(def nose-five
  (make-nose
   {:path "M29.122 38C12.8195 48.6959 23.9998 59 29.9999 62C35.9999 65 63.323 65 69.1615 62C74.9999 59 87.1336 49.635 69.1615 38"}))

(def nose-six
  (make-nose
   {:path "M26 58C35 34 66 35 73 58"}))

(def nose-seven
  (make-nose
   {:path "M41.9999 23C35.0782 44.1875 29.2879 56.5247 41.9999 73C48.6404 75.0677 52.3593 74.9407 58.9999 73C69.653 58.3905 66.6306 46.0478 58.9999 23"}))

(def nose-eight
  (make-nose {:path "M40.0002 23V57C40.0002 57 34.5994 54.9053 31.0002 55C27.781 55.0847 26.3365 56.5212 25.0001 59C22.3661 63.8856 34.0002 70 34.0002 70C34.0002 70 43.3282 75.87 50.0002 76C57.0392 76.1371 67.0002 70 67.0002 70C67.0002 70 77.4837 63.6953 75.0001 59C73.6833 56.5107 72.2195 55.0847 69.0002 55C65.401 54.9053 60.0002 57 60.0002 57V23"}))

(def nose-nine
  (make-nose {:path "M22 41C22 41 21.6999 49.0107 25 52C28.236 54.9312 36 54 36 54C36 54 42 63 50 63C58 63 63 54 63 54C63 54 71.542 55.2578 75 52C78.2409 48.9467 78 41 78 41"}))

(def nose-ten
  (make-nose {:path "M42 31C37 43 30 50 30 61C30 72 64 69 64 69"}))

(def nose-eleven
  (make-nose {:path "M30.1666 43C22.4157 56.0388 33.2178 68.6 39.0148 72.2571C44.8118 75.9143 55.2103 75.9143 60.8512 72.2571C66.4921 68.6 78.2151 57.1836 68.8512 43"}))

(def nose-twelve
  (make-nose {:path "M30 22C24.0327 44.888 23.2572 56.2794 28 69C32.7427 81.7206 68.3246 81.5541 72 69C75.6755 56.4459 77.8109 46.8374 70 22"}))

(def nose-thirteen
  (make-nose {:path "M36.9999 23.9999C36.9999 23.9999 31.4289 41.6326 32.2151 45.9999C11.9999 63 36.9999 69.8181 36.9999 69.8181C36.9999 69.8181 41.8921 77 50 77C58.1078 77 62 69.8181 62 69.8181C62 69.8181 89.9999 62 67.1481 45.9999C68.957 40.7576 62.8569 23.9999 62.8569 23.9999"}))

;; -------------------------
;; Mouth renderers
;; -------------------------

(defn mouth-root
  [& children]
  (into
   [:g {:transform "translate(-50 -50)"}]
   (with-keys children)))

(defn make-mouth
  "Create a mouth renderer from declarative layered paths.
   Supports explicit z-order via :z (lower = back, higher = front)."
  [{:keys [layers]}]

  ;; Pre-sort once at definition time (cheaper than per-render)
  (let [sorted-layers
        (sort-by (fn [{:keys [z]}] (or z 0)) layers)]

    (fn mouth-renderer [{:keys [lip-color]}]
      (mouth-root

       (for [{:keys [path role fill]} sorted-layers]
         ^{:key path}
         [:path
          {:d path
           :fill
           (case role
             :lips lip-color
             :teeth "white"
             :dark "black"
             :fixed (or fill "black")
             "black")}])))))

(def mouth-001
  (make-mouth
   {:layers
    [{:path "M84 46V53H17V46H84Z"
      :role :lips}]}))

(def mouth-002
  (make-mouth
   {:layers
    [{:path "M50 44C40.5 39 30.1296 40.9989 10.5 42.5C36 66 63 67.5 90 42.5C69.2151 40.2412 60 40.5 50 44Z"
      :role :lips}]}))

(def mouth-003
  (make-mouth
   {:layers
    [{:path "M8.4043 39.0479C10.9886 42.8925 16.4998 46.1506 24.2871 48.3945C31.9414 50.6001 41.2075 51.6537 50.4834 51.5625C59.7603 51.4713 68.8606 50.237 76.1816 47.9902C83.6956 45.6842 88.5631 42.5505 90.4688 39.25L96.5312 42.75C93.2407 48.4493 86.1484 52.2533 78.2363 54.6816C70.1313 57.1691 60.3381 58.4662 50.5527 58.5625C40.7664 58.6588 30.8002 57.5561 22.3496 55.1211C14.0321 52.7244 6.56519 48.8575 2.5957 42.9521L8.4043 39.0479Z"
      :role :lips}]}))

(def mouth-004
  (make-mouth
   {:layers
    [{:path "M84.9426 33.4295C88.5891 35.3782 91.5458 37.1333 93.8987 39.537C96.2975 41.9877 97.9583 44.9918 99.2883 49.2733L95.468 50.4598C94.5576 47.529 93.5357 45.4463 92.2913 43.7909C90.6192 45.547 88.421 46.9335 86.0295 48.0428C83.0743 49.4136 79.5609 50.4849 75.7522 51.3045C68.1322 52.9444 58.9534 53.6579 49.8381 53.5623C40.7172 53.4667 31.5044 52.559 23.802 50.8807C19.952 50.0418 16.4049 48.994 13.4045 47.7206C11.4063 46.8724 9.53508 45.8761 7.95825 44.6922C6.99085 46.1936 6.16296 48.0372 5.4104 50.4598L1.59009 49.2733C2.92008 44.9918 4.57999 41.9877 6.97876 39.537C9.3317 37.1331 12.289 35.3784 15.9358 33.4295L17.8206 36.9569C15.9591 37.9517 14.4028 38.8344 13.0745 39.7176C13.8979 40.2317 14.9139 40.7572 16.1389 41.2772C18.6189 42.3298 21.7206 43.2626 25.2922 44.0409C32.4334 45.5969 41.1586 46.4705 49.9124 46.5623C58.6718 46.6542 67.3061 45.9615 74.2795 44.4608C77.7674 43.7102 80.7466 42.7775 83.0842 41.6932C84.8756 40.8623 86.1476 40.0076 86.9924 39.1961C85.851 38.4834 84.5532 37.756 83.0579 36.9569L84.9426 33.4295Z"
      :role :lips}]}))

(def mouth-005
  (make-mouth
   {:layers
    [     ;; Mouth interior
     {:path "M83.5859 52C73.2686 60.4671 65.2736 64.5 50.5 64.5C35.6198 64.5 26.0722 60.6672 15.6484 52H83.5859Z"
      :role :dark}

     ;; Teeth
     {:path "M94.5 42.5L94.0195 42.9277C90.1469 46.3789 86.7562 49.3983 83.5859 52H15.6484C12.4122 49.3091 9.09075 46.1531 5.5 42.5H94.5Z"
      :role :teeth}

     ;; Lips
     {:path "M94.5 40C95.5374 40 96.4667 40.6409 96.8359 41.6104C97.2051 42.5797 96.9375 43.6761 96.1631 44.3662C87.8338 51.7882 81.4846 57.5053 74.7334 61.2959C67.8383 65.1672 60.6045 67 50.5 67C40.4388 67 32.5669 65.2961 25.2236 61.5039C17.9435 57.7443 11.3434 52.0119 3.71677 44.2529C3.0107 43.5346 2.80486 42.4621 3.19431 41.5332C3.58379 40.6044 4.49277 40 5.49998 40H94.5ZM11.5879 45C17.2529 50.4097 22.2546 54.3421 27.5185 57.0605C34.0111 60.4134 41.0612 62 50.5 62C59.8955 62 66.2581 60.321 72.2861 56.9365C77.191 54.1826 81.9226 50.2779 87.915 45H11.5879Z"
      :role :lips}]}))

(def mouth-006
  (make-mouth
   {:layers
    [{:path "M100 41C61.7502 44.0479 39.8688 44.1197 0 41C0 41 18 54.5 50.5 54.5C83 54.5 100 41 100 41Z"
      :role :dark}]}))

(def mouth-007
  (make-mouth
   {:layers
    [{:path "M86 49.5C67.5 69 31 68.5 15.5 49.5C33.5 35.5 68 35.5 86 49.5Z"
      :role :lips}]}))

(def mouth-008
  (make-mouth
   {:layers
    [{:path "M50.4995 42C60.1175 42 65.6602 46.1752 70.9409 48.6182C73.6285 49.8615 76.492 50.8421 80.2339 51.1104C84.0094 51.381 88.8379 50.9372 95.4302 49.1094L97.0337 54.8906C89.9638 56.8508 84.4317 57.4263 79.8052 57.0947C75.1452 56.7607 71.5646 55.5171 68.4224 54.0635C62.0433 51.1124 58.3813 48 50.4995 48C42.5662 48.0001 37.9417 51.3183 30.979 54.3232C27.5819 55.7893 23.7974 57.0499 19.1655 57.3525C14.5398 57.6547 9.24094 56.9915 2.78564 54.8467L4.67822 49.1533C10.5388 51.1005 15.0569 51.6082 18.7749 51.3652C22.4868 51.1227 25.5738 50.1214 28.6021 48.8145C34.4899 46.2733 40.9334 42.0001 50.4995 42Z"
      :role :lips}]}))

(def mouth-009
  (make-mouth
   {:layers
    [{:path "M58.1982 37.7277C61.7965 36.8746 65.4421 37.0885 69.2422 38.1144C76.6571 40.1162 85.0966 45.3558 95.6807 52.5148L92.3193 57.4855C81.579 50.2208 73.9604 45.6024 67.6777 43.9064C64.6292 43.0835 62.0158 42.9886 59.582 43.5655C57.1393 44.1447 54.6562 45.4539 51.9551 47.7755C50.8849 48.695 49.3185 48.7447 48.1924 47.8946C45.1957 45.632 42.4735 44.3604 39.833 43.8185C37.2028 43.2787 34.4652 43.4238 31.375 44.2648C25.0182 45.9948 17.5656 50.5317 7.16895 57.4933L3.83105 52.507C14.0666 45.6533 22.3313 40.5071 29.7998 38.4747C33.6223 37.4345 37.3255 37.1791 41.04 37.9415C44.0737 38.5642 46.9884 39.841 49.8867 41.7491C52.5475 39.7737 55.2851 38.4183 58.1982 37.7277Z"
      :role :lips}]}))

(def mouth-010
  (make-mouth
   {:layers
    [{:path "M78.5205 29.3203C82.1163 36.0402 84.7029 41.8134 86.5049 48.7725C88.3001 55.7055 89.2897 63.7118 89.8135 74.8838L84.8193 75.1172C84.3545 65.2043 83.5229 58.0414 82.1426 52H19.1729C17.7926 58.0414 16.9619 65.2043 16.4971 75.1172L11.5029 74.8838C12.0268 63.7118 13.0163 55.7055 14.8115 48.7725C16.6136 41.8134 19.2001 36.0402 22.7959 29.3203L27.2041 31.6797C24.654 36.4454 22.6924 40.602 21.1699 45H80.1465C78.624 40.602 76.6615 36.4455 74.1113 31.6797L78.5205 29.3203Z"
      :role :lips}]}))

(def mouth-011
  (make-mouth
   {:layers
    [     ;; Interior (back)
     {:z 0
      :path "M27.841 49.8167C44.9141 49.0411 55.7825 49.0741 72.3663 49.8274C78.0317 58.0061 68.9132 59.0911 68.9132 59.0911C54.1407 61.3704 45.8606 61.2431 31.088 59.0911C31.0271 59.0804 22.8372 57.6302 27.841 49.8167Z"
      :role :dark}

     ;; Teeth (middle)
     {:z 1
      :path "M31.0889 45.8189C44.526 33.9695 54.4799 33.4955 68.9131 45.8189C70.4213 47.3152 71.5486 48.6458 72.3672 49.8277C55.7832 49.0743 44.9148 49.0414 27.8418 49.817C28.5983 48.6357 29.6556 47.308 31.0889 45.8189Z"
      :role :teeth}

     ;; Lips (front)
     {:z 2
      :path "M49.6079 34.7543C56.0879 34.6901 62.4472 37.8136 69.5249 43.7181L70.2124 44.2982L70.2691 44.347L70.3218 44.3998C73.4025 47.456 75.1602 50.0429 75.8618 52.2982C76.606 54.6903 76.1439 56.6854 74.9448 58.1605C73.8519 59.505 72.3158 60.209 71.2388 60.5765C70.6749 60.7689 70.1705 60.8913 69.8042 60.9662C69.62 61.0038 69.4675 61.0307 69.356 61.0482C69.3001 61.057 69.2538 61.063 69.2192 61.0677C69.2156 61.0682 69.2119 61.0683 69.2085 61.0687C54.2274 63.3796 45.7472 63.248 30.8003 61.0707L30.7739 61.0668L30.7476 61.0619L31.0884 59.0912C30.7471 61.0619 30.7446 61.0619 30.7446 61.0619L30.7417 61.0609C30.7417 61.0609 30.7379 61.0603 30.7358 61.0599C30.7316 61.0592 30.7267 61.058 30.7212 61.057C30.7097 61.0549 30.695 61.0524 30.6782 61.0492C30.6448 61.0427 30.6012 61.0342 30.5483 61.0228C30.4423 61 30.2978 60.9664 30.1245 60.9203C29.7801 60.8285 29.3076 60.6832 28.7808 60.4642C27.7656 60.0423 26.3536 59.2672 25.3608 57.892C24.2944 56.4146 23.8744 54.4676 24.5474 52.1371C25.1893 49.9142 26.8065 47.3842 29.648 44.432L29.7046 44.3734L29.7661 44.3197C36.6147 38.2803 42.9182 34.8206 49.6079 34.7543ZM49.647 38.7543C44.4088 38.8063 39.0344 41.4918 32.4741 47.264C29.8807 49.9698 28.773 51.9248 28.3911 53.2474C28.0378 54.4713 28.302 55.1315 28.604 55.5502C28.9797 56.0706 29.6205 56.4808 30.3159 56.7699C30.6443 56.9064 30.9422 56.9987 31.1538 57.055C31.2583 57.0829 31.3392 57.1011 31.3882 57.1117C31.3978 57.1137 31.4065 57.1151 31.4136 57.1166C45.9851 59.2375 54.0626 59.3589 68.6079 57.1146L68.6431 57.1097L68.6704 57.1058H68.6685C68.6685 57.1058 68.6716 57.1054 68.6753 57.1049C68.6852 57.1035 68.7052 57.1015 68.7339 57.097C68.7915 57.088 68.8837 57.0715 69.0024 57.0472C69.2425 56.9981 69.5778 56.9173 69.9468 56.7914C70.7361 56.522 71.4402 56.1293 71.8403 55.6371C72.1343 55.2755 72.418 54.6938 72.0425 53.4867C71.6265 52.1496 70.4087 50.1296 67.5493 47.2845C60.5014 41.2804 54.8863 38.7023 49.647 38.7543Z"
      :role :lips}]}))

(def mouth-012
  (make-mouth
   {:layers
    [{:path "M82 46.5786C65.6596 25.8071 34.3404 25.8071 18 46.5785V54.0444C33.7836 74.7871 67.0102 75.2231 82 54V46.5786Z"
      :role :lips}]}))

(def mouth-013
  (make-mouth
   {:layers
    [     ;; Interior (back)
     {:z 0
      :path "M16.5 37C42.6815 44.0055 56.4845 45.1328 85 37.5L90 45.5C69.004 63.1962 34.9991 62.4986 12 45.5L16.5 37Z"
      :role :dark}

     ;; Teeth (middle)
     {:z 1
      :path "M32 40C44.8423 42.8965 55.2591 43.2875 69 40.4899V56.3894C57.2066 60.1833 44.0785 59.807 32 55.4888V40Z"
      :role :teeth}

     ;; Lips (front)
     {:z 2
      :path "M16.5898 35.0684C29.6343 38.5587 39.4445 40.5407 49.4873 40.7393C59.5188 40.9376 69.8989 39.3577 84.0557 35.5684L85.4854 35.1855L92.1885 45.9111L90.8623 47.0293C69.0616 65.4037 34.0217 64.5784 10.3848 47.1084L9 46.085L15.0508 34.6562L16.5898 35.0684ZM14.1582 44.8896C35.9786 60.0851 67.0819 60.6208 86.9404 45.0615L83.6562 39.8076C70.0079 43.3816 59.5986 44.9407 49.4082 44.7393C39.2906 44.5392 29.4969 42.6063 17.0967 39.3389L14.1582 44.8896Z"
      :role :lips}]}))

(def mouth-014
  (make-mouth
   {:layers
    [{:path "M87.9893 32.2119C84.1238 37.2854 82.234 41.6658 81.957 45.8203C81.6818 49.9493 82.9814 54.149 86.0762 58.9102L82.7217 61.0898C80.3968 57.513 78.8678 54.0235 78.2422 50.5H21.6572C21.0316 54.0235 19.5026 57.5131 17.1777 61.0898L13.8232 58.9102C16.918 54.149 18.2176 49.9493 17.9424 45.8203C17.6654 41.6658 15.7747 37.2855 11.9092 32.2119L15.0908 29.7881C18.6815 34.5009 20.9332 38.9829 21.6914 43.5H78.208C78.9662 38.9829 81.2171 34.5008 84.8076 29.7881L87.9893 32.2119Z"
      :role :lips}]}))

(def mouth-015
  (make-mouth
   {:layers
    [{:path "M49.6195 36.7743C40.1195 27.7743 33.1186 37.5001 14.1187 39.0001C14.1187 39.0001 12.567 43.5103 13.1186 43.9999C31.5374 70.7508 67.4787 72.0783 87.1195 43.9999C87.6682 43.511 86.1186 39.9999 86.1186 39.9999C69.6176 37.9999 59.6195 27.2743 49.6195 36.7743Z"
      :role :lips}]}))

(def mouth-016
  (make-mouth
   {:layers
    [{:path "M50 35.5C32.9488 35.5 31.4868 43.3962 12.5 40.9123C12.5 40.9123 7.89085 45.0052 8.50006 45.5C22.8449 76.5378 75.8054 76.3795 91.5 46C92.106 45.5058 87 40.9123 87 40.9123C68.7735 42.8909 67.0512 35.5 50 35.5Z"
      :role :lips}]}))

(def mouth-017
  (make-mouth
   {:layers
    [     ;; Lips (bottom)
     {:path "M10.9999 36.0001C41.7894 31.9537 58.8763 32.0442 88.9999 36.0001C89.6269 37.8674 90.0204 39.2895 90.2488 40.6234C90.4912 42.0394 90.5476 43.356 90.4999 45C70.4999 75 27.9999 73.5 9.99989 45C9.9208 43.2627 9.89909 41.8951 9.99989 40.6234C10.1205 39.1013 10.4167 37.7167 10.9999 36.0001Z"
      :role :lips}

     ;; Teeth
     {:path "M10.5 40C41.8911 43.0347 59.2757 42.9666 90 40C70.4702 57.008 29.5 56.5 10.5 40Z"
      :role :teeth}]}))

(def mouth-018
  (make-mouth
   {:layers
    [{:z 0
      :path "M20 46C29.7981 45.7405 38.5 32 50.5 32C60.2897 31.652 71.2098 45.4034 81 46V48C74.5389 48.5941 62.5 63 50.5 63C40.3004 63.3047 25.4921 48.5071 20 48V46Z"
      :role :dark}

     {:z 1
      :path "M50.5 32.0004C60.2897 31.6523 71.2098 45.4038 81 46.0004V48.0004H20V46.0004C29.7981 45.7408 38.5 32.0004 50.5 32.0004Z"
      :role :teeth}

     {:z 2
      :path "M50.5 29.0014C53.6125 28.9158 56.611 29.9276 59.3379 31.2621C62.1007 32.6142 64.8506 34.4323 67.4199 36.1537C70.057 37.9206 72.5047 39.586 74.8975 40.8676C77.2957 42.1521 79.3652 42.8945 81.1826 43.0053L84 43.1772V50.7367L81.2744 50.9877C80.4721 51.0616 79.0679 51.6675 76.8213 53.1156C74.6364 54.5241 72.3364 56.2531 69.5332 58.1908C64.273 61.8271 57.5484 66.0004 50.5 66.0004V65.9985C47.2914 66.0727 43.9835 64.9924 40.9385 63.5766C37.825 62.1288 34.6978 60.1931 31.8359 58.311C28.8723 56.3619 26.3581 54.5859 24.0557 53.143C22.9357 52.4412 21.9784 51.8915 21.1797 51.5112C20.3375 51.1102 19.8846 51.0026 19.7246 50.9877L17 50.7358V43.0785L19.9209 43.0014C21.6849 42.9546 23.5731 42.2941 25.7529 41.0815C27.9546 39.8566 30.1688 38.2386 32.6914 36.4535C37.491 33.0572 43.4117 29.0004 50.5 29.0004V29.0014Z"
      :role :lips}]}))

(def mouth-019
  (make-mouth
   {:layers
    [{:z 0
      :path "M24.4999 33.5C31.9999 35.5003 68 36.5 78.4997 34C88.5 34 98.0001 51.9996 82.9996 57.9999C67.9992 64.0002 30.5001 63.9996 17.9997 57.9999C5.4993 52.0002 9.49997 34 24.4999 33.5Z"
      :role :teeth}

     {:z 1 :path "M34.5 60H28.5V36.5H34.5V60Z" :role :fixed}
     {:z 1 :path "M53 60H47V36.5H53V60Z" :role :fixed}
     {:z 1 :path "M72 60H66V36.5H72V60Z" :role :fixed}

     {:z 2
      :path "M25.273 30.6016C26.8372 31.0187 30.2238 31.4434 34.8433 31.7812C39.3709 32.1124 44.8456 32.3455 50.4254 32.4385C56.0056 32.5315 61.6596 32.4838 66.5504 32.2607C71.5042 32.0348 75.4779 31.6362 77.8053 31.082L78.148 31H78.4996C81.9004 31 85.0389 32.5175 87.4918 34.6357C89.9548 36.7628 91.9222 39.6537 92.9713 42.8008C94.0225 45.9544 94.2008 49.5367 92.7974 52.8799C91.3724 56.2747 88.4763 59.0401 84.1138 60.7852C76.0624 64.0058 62.4626 65.5001 49.5621 65.5C43.0488 65.5 36.5827 65.1193 30.9156 64.3477C25.3122 63.5846 20.2535 62.4088 16.7017 60.7041C9.0978 57.0544 6.39117 49.5803 8.02498 42.9678C9.66066 36.3481 15.5625 30.7966 24.4 30.502L24.8443 30.4873L25.273 30.6016Z"
      :role :lips}]}))

(def mouth-020
  (make-mouth
   {:layers
    [{:path "M68.1807 63.9922C57.0982 64.9997 42.9672 65.2665 32.2627 63.9854L32.7373 60.0146C43.07 61.2513 56.902 61.0003 67.8193 60.0078L68.1807 63.9922Z"
      :role :lips}

     {:path "M87.1246 36.4999C86.6247 34.4999 87.6249 31.0004 90.1246 32.4999C92.6246 33.9998 95.1246 36.9999 95.6246 40.9999C96.1246 44.9998 93.6256 46.4996 92.1256 43.9999C91.7688 43.4053 91.3258 42.7832 90.8531 42.1522C67.8787 48.3841 34.0785 48.4359 9.10995 42.37C8.6988 42.9263 8.3162 43.4739 8.00058 43.9999C6.50056 46.4998 4.00058 44.9998 4.50058 40.9999C5.00061 36.9999 7.50058 33.9998 10.0006 32.4999C12.5003 31.0004 13.5005 34.4999 13.0006 36.4999C12.955 36.6822 12.8874 36.8724 12.8033 37.0702C35.8718 42.2092 66.079 42.1318 87.2477 36.8885C87.1975 36.7553 87.156 36.6256 87.1246 36.4999Z"
      :role :lips}]}))

(def mouth-021
  (make-mouth
   {:layers
    [{:path "M42.2601 28.3672C47.2414 27.2746 53.1324 28.5737 59.2757 33.0811L55.7259 37.919C50.6167 34.1704 46.4559 33.5894 43.5462 34.2276C40.5916 34.8757 38.4933 36.8598 37.5501 39.0938C36.6031 41.3372 36.8906 43.5639 38.2601 45.0909C41.1895 48.357 45.9688 46.782 49.8255 47.2022L49.4837 50.3389L49.8255 53.4825C45.9675 53.9028 41.1906 52.3264 38.2601 55.5938C36.8906 57.1207 36.6031 59.3475 37.5501 61.5909C38.4933 63.8248 40.5916 65.809 43.5462 66.4571C46.4559 67.0952 50.6168 66.5142 55.7259 62.7657L59.2757 67.6036C53.1324 72.1109 47.2414 73.41 42.2601 72.3174C37.324 71.2345 33.6915 67.8768 32.0228 63.9239C30.3579 59.98 30.5775 55.1736 33.7933 51.5879C34.193 51.1423 34.628 50.7261 35.0989 50.3418C34.6282 49.9577 34.1928 49.5422 33.7933 49.0967C30.5775 45.511 30.3579 40.7046 32.0228 36.7608C33.6915 32.8078 37.324 29.4501 42.2601 28.3672Z"
      :role :lips}]}))

;; -------------------------
;; Feature registry
;; -------------------------

(def feature-registry
  {:head
   {:default :average
    :shapes head-registry}

   :hair
   {:default :bald
    :shapes
    {:bald {:label "Bald" :render hair-bald :order 0}
     :one {:label "Hair 001" :render hair-001 :order 1}
     :two {:label "Hair 002" :render hair-002 :order 2}}}

   :eyes
   {:default :001
    :shapes
    {:001 {:label "001" :render eye-001 :order 1}
     :002 {:label "002" :render eye-002 :order 2}
     :003 {:label "003" :render eye-003 :order 3}
   
     :004 {:label "004" :render eye-004 :order 4}
     :005 {:label "005" :render eye-005 :order 5}
     :006 {:label "006" :render eye-006 :order 6}
   
     :007 {:label "007" :render eye-007 :order 7}
     :008 {:label "008" :render eye-008 :order 8}
     :009 {:label "009" :render eye-009 :order 9}
     :010 {:label "010" :render eye-010 :order 10}
     :011 {:label "011" :render eye-011 :order 11}
     :012 {:label "012" :render eye-012 :order 12}
     :013 {:label "013" :render eye-013 :order 13}
     :014 {:label "014" :render eye-014 :order 14}
     :015 {:label "015" :render eye-015 :order 15}}}

   :nose
   {:default :one
    :shapes
    {:none {:label "None" :render nose-none :order 0}
     :one {:label "One" :render nose-one :order 1}
     :two {:label "Two" :render nose-two :order 2}
     :three {:label "Three" :render nose-three :order 3}
     :four {:label "Four" :render nose-four :order 4}
     :five {:label "Five" :render nose-five :order 5}
     :six {:label "Six" :render nose-six :order 6}
     :seven {:label "Seven" :render nose-seven :order 7}
     :eight {:label "Eight" :render nose-eight :order 8}
     :nine {:label "Nine" :render nose-nine :order 9}
     :ten {:label "Ten" :render nose-ten :order 10}
     :eleven {:label "Eleven" :render nose-eleven :order 11}
     :twelve {:label "Twelve" :render nose-twelve :order 12}
     :thirteen {:label "Thirteen" :render nose-thirteen :order 13}}}

   :mouth
   {:default :one
    :shapes
    {:one {:label "001" :render mouth-001 :order 1}
     :two {:label "002" :render mouth-002 :order 2}
     :three {:label "003" :render mouth-003 :order 3}
     :four {:label "004" :render mouth-004 :order 4}
     :five {:label "005" :render mouth-005 :order 5}
     :six {:label "006" :render mouth-006 :order 6}
     :seven {:label "007" :render mouth-007 :order 7}
     :eight {:label "008" :render mouth-008 :order 8}
     :nine {:label "009" :render mouth-009 :order 9}
     :ten {:label "010" :render mouth-010 :order 10}
     :eleven {:label "011" :render mouth-011 :order 11}
     :twelve {:label "012" :render mouth-012 :order 12}
     :thirteen {:label "013" :render mouth-013 :order 13}
     :fourteen {:label "014" :render mouth-014 :order 14}
     :fifteen {:label "015" :render mouth-015 :order 15}
     :sixteen {:label "016" :render mouth-016 :order 16}
   
     :seventeen {:label "017" :render mouth-017 :order 17}
   
     :eighteen {:label "018" :render mouth-018 :order 18}
     :nineteen {:label "019" :render mouth-019 :order 19}
     :twenty {:label "020" :render mouth-020 :order 20}
     :twenty-one {:label "021" :render mouth-021 :order 21}}}

   ;; Keep placeholders for non-migrated features so normalization and
   ;; renderer resolution can still be defensive.  
   
   :ears {:default :none :shapes {:none {:label "None" :render (fn [_] nil) :order 0}}}
   
   :brows
   {:default :none
    :shapes
    {:none {:label "None" :render brow-none :order 0}
     :001 {:label "001" :render brow-001 :order 1}
     :002 {:label "002" :render brow-002 :order 2}
     :003 {:label "003" :render brow-003 :order 3}
     :004 {:label "004" :render brow-004 :order 4}
     :005 {:label "005" :render brow-005 :order 5}
     :006 {:label "006" :render brow-006 :order 6}
     :007 {:label "007" :render brow-007 :order 7}
     :008 {:label "008" :render brow-008 :order 8}}}})

(defn sorted-shape-entries [feature]
  (->> (get-in feature-registry [feature :shapes])
       (sort-by (fn [[_ {:keys [order]}]] (or order 9999)))
       vec))

(defn resolve-renderer [feature shape]
  (or (get-in feature-registry [feature :shapes shape :render])
      (get-in feature-registry [feature :shapes (get-in feature-registry [feature :default]) :render])
      (fn [_] nil)))

;; -------------------------
;; Spec normalization
;; -------------------------

(defn valid-shape?
  [feature shape]
  (contains? (get-in feature-registry [feature :shapes]) shape))

(defn ->kw [x]
  (cond
    (keyword? x) x
    (string? x)  (keyword x)
    :else        nil))

(defn normalize-feature
  "Fix JSON string -> keyword mismatch, enforce valid shape values, apply defaults defensively."
  [spec feature]
  (let [default-shape (get-in feature-registry [feature :default])]
    (update-in spec [:parts feature]
               (fn [part]
                 (let [shape (->kw (:shape part))]
                   (if (valid-shape? feature shape)
                     (assoc (or part {}) :shape shape)
                     (assoc (or part {}) :shape default-shape)))))))

(defn ->color-kw [v]
  (cond
    (keyword? v) v
    (string? v)  (keyword v)
    :else        nil))

(defn normalize-spec [spec]
  (-> spec
      (normalize-feature :eyes)
      (normalize-feature :head)
      (normalize-feature :nose)
      (normalize-feature :ears)
      (normalize-feature :mouth)
      (normalize-feature :hair)
      (normalize-feature :brows)
      (update-in [:parts :head :skin] ->color-kw)
      (update-in [:parts :eyes :iris] ->color-kw)
      (update-in [:parts :hair :color] ->color-kw)
      (update-in [:parts :mouth :color] ->color-kw)
      (update-in [:parts :brows :color] ->color-kw)

      ;; ensure defaults  (treat nil as missing) 
      (update-in [:parts :nose :stroke] #(or % "black"))
      (update-in [:parts :nose :size] #(or % 1.0))
      (update-in [:parts :nose :y-offset] #(or % 0))
      (update-in [:parts :mouth :size] #(or % 1.0))
      (update-in [:parts :mouth :y-offset] #(or % 0))

      (update-in [:parts :head :skin]
                 #(if (contains? cfg/skin-tones %)
                    %
                    :light-cream))
      (update-in [:parts :hair :color]
                 #(if (contains? cfg/hair-colors %)
                    %
                    :jet-black))
      (update-in [:parts :brows]
                 #(or % {:shape :none :color :jet-black :size 1.0 :x-offset 0 :y-offset 0 :rotation 0}))
      (update-in [:parts :brows :color]
                 #(if (contains? cfg/hair-colors %)
                    %
                    :jet-black))

      (update-in [:parts :eyes :iris]
                 #(if (contains? cfg/iris-colors %)
                    %
                    :black))
      (update-in [:parts :mouth :color]
                 #(if (contains? cfg/lip-colors %)
                    %
                    :black))
      (update-in [:parts :eyes :spacing] #(or % 0.54))
      (update-in [:parts :eyes :size] #(or % 1.1))
      (update-in [:parts :eyes :y-offset] #(or % 0))

      (update-in [:parts :eyes :rotation] #(or % 0))))

(defn clamp
  [mn mx v]
  (-> v (max mn) (min mx)))

(defn clamp-cfg
  [k value]
  (let [{:keys [min max]} (get cfg/constants k)]
    (if (and (number? min) (number? max) (number? value))
      (clamp min max value)
      value)))

;; -------------------------
;; Avatar render pipeline
;; -------------------------

(defn head-transform []
  (str "translate(" (:head/cx cfg/geometry) " "
       (+ (:head/cy cfg/geometry) (:head/y-offset cfg/geometry)) ") "
       "scale(" (:head/scale cfg/geometry) ")"))

(defn head-svg [{:keys [shape skin]}]
  (let [renderer (resolve-renderer :head shape)
        skin-hex (get cfg/skin-tones skin (get cfg/skin-tones :light-cream))]
    [:g {:transform (head-transform)}
     [renderer {:skin skin-hex}]]))

(defn hair-svg [{:keys [shape color]}]
  (let [renderer (resolve-renderer :hair shape)
        layers   (renderer {:color (get cfg/hair-colors color (get cfg/hair-colors :jet-black))})]
    {:back
     (when (:back layers)
       [:g {:transform (head-transform)}
        (:back layers)])

     :front
     (when (:front layers)
       [:g {:transform (head-transform)}
        (:front layers)])

     :front2
     (when (:front2 layers)
       [:g {:transform (head-transform)}
        (:front2 layers)])}))

(defn ears-svg [_ears _head] nil)
(defn mouth-svg [{:keys [shape color size y-offset]}]
  (let [renderer (resolve-renderer :mouth shape)
        base-scale (:mouth/scale cfg/geometry)
        user-scale (clamp-cfg :mouth/size (or size 1.0))
        sc (* base-scale user-scale)
        y (+ (:mouth/base-y cfg/geometry)
             (clamp-cfg :mouth/y-offset (or y-offset 0)))
        cx (:head/cx cfg/geometry)]
    [:g {:transform
         (str "translate(" cx " " y ") "
              "scale(" sc ")")}
     (renderer {:lip-color (get cfg/lip-colors color (get cfg/lip-colors :black))})]))
(defn nose-svg [{:keys [shape stroke size y-offset]} _head]
  (when (not= shape :none)
    (let [renderer (resolve-renderer :nose shape)
          base-scale (:nose/scale cfg/geometry)
          user-scale (clamp-cfg :nose/size (or size 1.0))
          final-scale (* base-scale user-scale)
          base-y (:nose/base-y cfg/geometry)
          user-y (clamp-cfg :nose/y-offset (or y-offset 0))
          final-y (+ base-y user-y)
          cx (:head/cx cfg/geometry)]
      [:g {:transform
           (str "translate(" cx " " final-y ") "
                "scale(" final-scale ")")}
       (renderer {:stroke (or stroke "black")
                  :fill "none"})])))
(defn eyes-svg [{:keys [spacing size y-offset iris shape rotation]}]
  (let [s (clamp-cfg :eyes/spacing (or spacing 0.54))
        sc (clamp-cfg :eyes/size (or size 1.1))
        y (clamp-cfg :eyes/y-offset (or y-offset 0))
        rot (clamp-cfg :eyes/rotation (or rotation 0))
        dx (* (:eyes/dx-scale cfg/geometry) s)
        cy (+ (:eyes/base-y cfg/geometry) y)
        eye-fn (resolve-renderer :eyes shape)
        head-cx (:head/cx cfg/geometry)
        iris-hex (get cfg/iris-colors iris (get cfg/iris-colors :black))]
    [:g
     [:g {:transform
          (str "translate(" (- head-cx dx) " " cy ") "
               "rotate(" (* -1 rot) ") "
               "scale(" sc ") "
               "scale(-1 1)")}
      (eye-fn {:iris iris-hex :mirrored? true})]
     [:g {:transform
          (str "translate(" (+ head-cx dx) " " cy ") "
               "rotate(" rot ") "
               "scale(" sc ")")}
      (eye-fn {:iris iris-hex :mirrored? false})]]))
(defn brows-svg
  [{:keys [shape color size x-offset y-offset rotation]}]
  (when (not= shape :none)
    (let [sc (clamp-cfg :brows/size (or size 1.0))
          xoff (clamp-cfg :brows/x-offset (or x-offset 0))
          yoff (clamp-cfg :brows/y-offset (or y-offset 0))
          rot (clamp-cfg :brows/rotation (or rotation 0))
          head-cx (:head/cx cfg/geometry)
          cy (+ (:brows/base-y cfg/geometry) yoff)
          dx (+ (:brows/base-dx cfg/geometry) xoff)
          brow-fn (resolve-renderer :brows shape)
          brow-color (get cfg/hair-colors color (get cfg/hair-colors :jet-black))]
      [:g
       [:g {:transform
            (str "translate(" (- head-cx dx) " " cy ") "
                 "rotate(" (* -1 rot) ") "
                 "scale(" sc ") "
                 "scale(-1 1)")}
        (brow-fn {:color brow-color})]
       [:g {:transform
            (str "translate(" (+ head-cx dx) " " cy ") "
                 "rotate(" rot ") "
                 "scale(" sc ")")}
        (brow-fn {:color brow-color})]])))
(defn glasses-svg [_glasses] nil)

(defn avatar->hiccup
  "Layering: back hair -> ears -> head -> mouth -> nose -> eyes -> brows -> front hair -> glasses."
  [spec]
  (let [spec* (normalize-spec spec)
        {:keys [head eyes ears mouth nose hair brows]} (:parts spec*)
        {:keys [back front front2]} (hair-svg hair)]
    [:svg {:xmlns "http://www.w3.org/2000/svg"
           :viewBox "0 0 512 512"
           ;; :width 200
           ;; :height 200
           }
     back
     (ears-svg ears head)
     (head-svg head)
     (mouth-svg mouth)
     (nose-svg nose head)
     (eyes-svg eyes)
     (brows-svg brows)
     front
     front2
     (glasses-svg (get-in spec* [:parts :other :glasses]))]))
